var LocationRunView,extend=function(t,e){function l(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return l.prototype=e.prototype,t.prototype=new l,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;LocationRunView=function(e){function l(){return l.__super__.constructor.apply(this,arguments)}return extend(l,e),l.prototype.className="LocationRunView",l.prototype.events={"click .school_list li":"autofill","keyup input":"showOptions","click .clear":"clearInputs","change select":"onSelectChange"},l.prototype.i18n=function(){return this.text={clear:t("LocationRunView.button.clear")}},l.prototype.initialize=function(t){var e,l,i,s,n,o,a,r,h,c,u,p,f;for(this.i18n(),this.model=t.model,this.parent=t.parent,this.dataEntry=t.dataEntry,this.levels=this.model.get("levels")||[],this.locations=this.model.get("locations")||[],1===this.levels.length&&""===this.levels[0]&&(this.levels=[]),1===this.locations.length&&""===this.locations[0]&&(this.locations=[]),this.haystack=[],u=this.locations,e=l=0,s=u.length;s>l;e=++l)for(r=u[e],this.haystack[e]=[],i=0,n=r.length;n>i;i++)h=r[i],this.haystack[e].push(h.toLowerCase());for(f="<li data-index='{{i}}'>",p=this.levels,e=c=0,o=p.length;o>c;e=++c)a=p[e],f+="{{level_"+e+"}}",e!==this.levels.length-1&&(f+=" - ");return f+="</li>",this.li=_.template(f)},l.prototype.clearInputs=function(){return this.$el.empty(),this.render()},l.prototype.autofill=function(t){var e,l,i,s,n,o,a,r;for(this.$el.find(".autofill").fadeOut(250),l=$(t.target).attr("data-index"),o=this.locations[l],a=this.levels,r=[],e=i=0,s=a.length;s>i;e=++i)n=a[e],r.push(this.$el.find("#level_"+e).val(o[e]));return r},l.prototype.showOptions=function(t){var e,l,i,s,n,o,a,r,h,c,u,p,f,d,v,g,y,_,m,b,k,w,x;for(v=$(t.target).val().toLowerCase(),l=parseInt($(t.target).attr("data-level")),y=a=0,_=this.haystack.length;_>=0?_>=a:a>=_;y=_>=0?++a:--a)this.$el.find("#autofill_"+y).hide();for(e=!1,w=[],m=this.haystack,s=r=0,h=m.length;h>r;s=++r)x=m[s],n=~this.haystack[s][l].indexOf(v),n&&w.push(s),n&&(e=!0);for(b=this.haystack,s=f=0,c=b.length;c>f;s=++f)for(x=b[s],o=d=0,u=x.length;u>d;o=++d)y=x[o],o!==l&&(n=~this.haystack[s][o].indexOf(v),n&&!~w.indexOf(s)&&w.push(s),n&&(e=!0));if(e){for(i="",g=0,p=w.length;p>g;g++)k=w[g],i+=this.getLocationLi(k);return this.$el.find("#autofill_"+l).fadeIn(250),this.$el.find("#school_list_"+l).html(i)}return this.$el.find("#autofill_"+l).fadeOut(250)},l.prototype.getLocationLi=function(t){var e,l,i,s,n,o;for(o={i:t},n=this.locations[t],e=l=0,i=n.length;i>l;e=++l)s=n[e],o["level_"+e]=s;return this.li(o)},l.prototype.render=function(){var e,l,i,s,n,o,a,r,h,c,u,p,f,d;if(d="",e="<button class='clear command'>"+this.text.clear+"</button>",this.dataEntry||(c=this.parent.parent.result.getByHash(this.model.get("hash"))),this.typed)for(p=this.levels,l=s=0,o=p.length;o>s;l=++s)r=p[l],u="",c&&(u=c.location[l]),e+="<div class='label_value'> <label for='level_"+l+"'>"+r+"</label><br> <input data-level='"+l+"' id='level_"+l+"' value='"+(u||"")+"'> </div> <div id='autofill_"+l+"' class='autofill' style='display:none'> <h2>"+t("select one from autofill list")+"</h2> <ul class='school_list' id='school_list_"+l+"'> </ul> </div>";else for(f=this.levels,l=n=0,a=f.length;a>n;l=++n)r=f[l],u="",c&&(u=c.location[l]),h=this.getOptions(l,u),i=0!==l&&!u&&"disabled='disabled'",e+="<div class='label_value'> <label for='level_"+l+"'>"+r+"</label><br> <select id='level_"+l+"' data-level='"+l+"' "+(i||"")+"> "+h+" </select> </div>";return this.$el.html(e),this.trigger("rendered"),this.trigger("ready")},l.prototype.onSelectChange=function(t){var e,l,i,s,n,o;return l=$(t.target),i=parseInt(l.attr("data-level")),s=l.val(),n=i+1,i!==this.levels.length&&(this.$el.find("#level_"+n).removeAttr("disabled"),e=this.$el.find("#level_"+n).html(this.getOptions(n)),1===(o=e.find("option")).length)?o.parent("select").trigger("change"):void 0},l.prototype.getOptions=function(t,e){var l,i,s,n,o,a,r,h,c,u,p,f,d,v,g,y,$,m,b;for(l=[],h="",d=!1,f=[],i=o=0,g=t;(g>=0?g>=o:o>=g)&&i!==t;i=g>=0?++o:--o)f.push(this.$el.find("#level_"+i).val());for(y=this.locations,i=a=0,r=y.length;r>a;i=++a)if(c=y[i],!~l.indexOf(c[t])){for(s=0===t,n=!0,i=p=0,$=Math.max(t-1,0);$>=0?$>=p:p>=$;i=$>=0?++p:--p)if(f[i]!==c[i]&&!e){n=!1;break}(s||n)&&(l.push(c[t]),u=_(c[t]).escape(),c[t]===e?(b="selected='selected'",d=!0):b="",h+="<option value='"+u+"' "+(b||"")+">"+u+"</option>")}return d||(m="selected='selected'"),v="<option "+(m||"")+" disabled='disabled'>Please select a "+this.levels[t]+"</option>",1===l.length?h:v+" "+h},l.prototype.getResult=function(){var t,e;return{labels:function(){var t,l,i,s;for(i=this.levels,s=[],t=0,l=i.length;l>t;t++)e=i[t],s.push(e.replace(/[\s-]/g,"_"));return s}.call(this),location:function(){var l,i,s,n;for(s=this.levels,n=[],t=l=0,i=s.length;i>l;t=++l)e=s[t],n.push($.trim(this.$el.find("#level_"+t).val()));return n}.call(this)}},l.prototype.getSkipped=function(){var t,e;return{labels:function(){var t,l,i,s;for(i=this.levels,s=[],t=0,l=i.length;l>t;t++)e=i[t],s.push(e.replace(/[\s-]/g,"_"));return s}.call(this),location:function(){var l,i,s,n;for(s=this.levels,n=[],t=l=0,i=s.length;i>l;t=++l)e=s[t],n.push("skipped");return n}.call(this)}},l.prototype.isValid=function(){var t,e,l,i,s,n,o;for(this.$el.find(".message").remove(),i=this.$el.find("input"),o=this.$el.find("select"),t=o.length>0?o:i,e=s=0,n=t.length;n>s;e=++s)if(l=t[e],!$(l).val())return!1;return!0},l.prototype.showErrors=function(){var e,l,i,s,n,o,a,r;for(i=this.$el.find("input"),r=this.$el.find("select"),e=r.length>0?r:i,a=[],s=0,n=e.length;n>s;s++)l=e[s],$(l).val()?a.push(void 0):(o=$("label[for="+$(l).attr("id")+"]").text(),a.push($(l).after(" <span class='message'>"+t("LocationRunView.message.must_be_filled",{levelName:o})+"</span>")));return a},l}(Backbone.View);