var Session,TabletUser,bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function n(){this.constructor=t}for(var r in e)hasProp.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty,indexOf=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};Session=function(){function t(){}return t.prototype.set=function(t){return window.localStorage.setItem("user",t)},t.prototype.get=function(){return window.localStorage.getItem("user")},t.prototype["delete"]=function(){return window.localStorage.removeItem("user")},t.prototype.exists=function(){return null!==window.localStorage.getItem("user")},t}(),TabletUser=function(e){function n(){return this.signup=bind(this.signup,this),n.__super__.constructor.apply(this,arguments)}return extend(n,e),n.prototype.url="user",n.prototype.RECENT_USER_MAX=3,n.prototype.initialize=function(){return this.myRoles=[]},n.prototype.name=function(){return this.get("name")||null},n.prototype.roles=function(){return this.getArray("roles")},n.prototype.isAdmin=function(){return indexOf.call(this.roles(),"_admin")>=0},n.prototype.recentUsers=function(){return Tangerine.settings.getArray("recentUsers")},n.prototype.setPassword=function(t){var e,r;return""===t&&this.trigger("pass-error","Password cannot be empty"),e=n.generateHash(t),r=e.salt,t=e.pass,this.set({pass:t,salt:r}),this},n.prototype.setId=function(t){return this.set({_id:n.calcId(t),name:t})},n.calcId=function(t){return"user-"+t},n.generateHash=function(t,e){return null==e&&(e=hex_sha1(""+Math.random())),t=hex_sha1(t+e),{pass:t,salt:e}},n.prototype.verifyPassword=function(t){var e,r,s;return r=this.get("salt"),e=this.get("pass"),s=n.generateHash(t,r).pass,s===e},n.prototype.ghostLogin=function(t,e){var n;return Tangerine.log.db("User","ghostLogin"),n=encodeURIComponent(window.location.toString()),document.location=Tangerine.settings.location.group.url.replace(/\:\/\/.*@/,"://")+("_ghost/"+t+"/"+e+"/"+n)},n.prototype.signup=function(t,e,r,s){return null==s&&(s={}),this.set({_id:n.calcId(t)}),this.fetch({success:function(t){return function(){return t.trigger("name-error","User already exists.")}}(this),error:function(n){return function(){return n.set({name:t}),n.setPassword(e),n.save(r,{success:function(){var r;return"class"===Tangerine.settings.get("context")?(r=new RegisterTeacherView({name:t,pass:e}),vm.show(r)):(Tangerine.session.set(n.id),n.trigger("login"),"function"==typeof s.success?s.success():void 0)}})}}(this)})},n.prototype.login=function(t,e,n){return null==n&&(n={}),Tangerine.session.exists()&&this.trigger("name-error","User already logged in"),_.isEmpty(this.attributes)||this.get("name")!==t?(this.setId(t),this.fetch({success:function(t){return function(){return t.attemptLogin(e,n)}}(this),error:function(){return Utils.midAlert("User does not exist.")}})):this.attemptLogin(e,n)},n.prototype.attemptLogin=function(e,n){var r;return null==n&&(n={}),this.verifyPassword(e)?(Tangerine.session.set(this.id),this.trigger("login"),"function"==typeof n.success&&n.success(),r=this.recentUsers().filter(function(t){return function(e){return!~e.indexOf(t.name())}}(this)),r.unshift(this.name()),r.length>this.RECENT_USER_MAX&&r.pop(),Tangerine.settings.save({recentUsers:r}),!0):(this.trigger("pass-error",t("LoginView.message.error_password_incorrect")),Tangerine.session["delete"](),"function"==typeof n.error&&n.error(),!1)},n.prototype.sessionRefresh=function(t){return Tangerine.session.exists()?(this.set({_id:Tangerine.session.get()}),this.fetch({error:function(){return"function"==typeof t.error?t.error():void 0},success:function(){return t.success()}})):t.success()},n.prototype.verify=function(t){return null===this.name()?null!=(null!=t?t.isUnregistered:void 0)?t.isUnregistered():Tangerine.router.navigate("login",!0):(null!=t&&"function"==typeof t.isAuthenticated&&t.isAuthenticated(),this.isAdmin()?null!=t&&"function"==typeof t.isAdmin?t.isAdmin():void 0:null!=t&&"function"==typeof t.isUser?t.isUser():void 0)},n.prototype.logout=function(){return this.clear(),Tangerine.session["delete"](),Tangerine.router.navigate("login",!0),Tangerine.log.app("User-logout","logout")},n}(Backbone.Model);