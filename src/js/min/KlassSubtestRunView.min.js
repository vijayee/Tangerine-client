var KlassSubtestRunView,bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function s(){this.constructor=t}for(var o in e)hasProp.call(e,o)&&(t[o]=e[o]);return s.prototype=e.prototype,t.prototype=new s,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;KlassSubtestRunView=function(t){function e(){return this.onPrototypeRendered=bind(this.onPrototypeRendered,this),e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.prototype.className="KlassSubtestRunView",e.prototype.events={"click .done":"done","click .cancel":"cancel","click .subtest_help":"toggleHelp"},e.prototype.toggleHelp=function(){return this.$el.find(".enumerator_help").fadeToggle(250)},e.prototype.initialize=function(t){return this.linkedResult=t.linkedResult,this.student=t.student,this.subtest=t.subtest,this.questions=t.questions,this.prototype=this.subtest.get("prototype"),this.protoViews=Tangerine.config.get("prototypeViews"),this.prototypeRendered=!1,"grid"===this.prototype?this.result=new KlassResult({prototype:"grid",startTime:(new Date).getTime(),itemType:this.subtest.get("itemType"),reportType:this.subtest.get("reportType"),studentId:this.student.id,subtestId:this.subtest.id,part:this.subtest.get("part"),klassId:this.student.get("klassId"),timeAllowed:this.subtest.get("timer")}):"survey"===this.prototype?(this.result=new KlassResult({prototype:"survey",startTime:(new Date).getTime(),studentId:this.student.id,subtestId:this.subtest.id,part:this.subtest.get("part"),klassId:this.student.get("klassId"),itemType:this.subtest.get("itemType"),reportType:this.subtest.get("reportType")}),this.questions.sort(),this.render()):void 0},e.prototype.render=function(){var t,e;return t=""!==(this.subtest.get("enumeratorHelp")||"")?"<button class='subtest_help command'>help</button><div class='enumerator_help'>"+this.options.subtest.get("enumeratorHelp")+"</div>":"",e=""!==(this.subtest.get("studentDialog")||"")?"<div class='student_dialog'>"+this.options.subtest.get("studentDialog")+"</div>":"",this.$el.html("<h2>"+this.options.subtest.get("name")+"</h2> "+t+" "+e),this.prototypeView=new(window[this.protoViews[this.subtest.get("prototype")].run])({model:this.subtest,parent:this}),this.prototypeView.on("rendered",this.onPrototypeRendered),this.prototypeView.render(),this.$el.append(this.prototypeView.el),this.prototypeRendered=!0,this.$el.append("<button class='done navigation'>Done</button> <button class='cancel navigation'>Cancel</button>"),this.trigger("rendered")},e.prototype.onPrototypeRendered=function(){return this.trigger("rendered")},e.prototype.getGridScore=function(){var t;return null==this.linkedResult.get("subtestData")?!1:t=this.linkedResult.get("subtestData").attempted||0},e.prototype.gridWasAutostopped=function(){var t;return(null!=(t=this.linkedResult.get("subtestData"))?t.auto_stop:void 0)||0},e.prototype.onClose=function(){var t;return null!=(t=this.prototypeView)&&"function"==typeof t.close?t.close():void 0},e.prototype.isValid=function(){return this.prototypeRendered&&null!=this.prototypeView.isValid?this.prototypeView.isValid():!1},e.prototype.getSkipped=function(){if(null!=this.prototypeView.getSkipped)return this.prototypeView.getSkipped();throw"Prototype skipping not implemented"},e.prototype.cancel=function(){return"test"===this.student.id?void history.back():Tangerine.router.navigate("class/"+this.options.student.get("klassId")+"/"+this.options.subtest.get("part"),!0)},e.prototype.done=function(){return"test"===this.student.id?void history.back():this.isValid()?Tangerine.$db.view(Tangerine.design_doc+"/resultsByStudentSubtest",{key:[this.options.student.id,this.subtest.id],success:function(t){return function(e){var s,o,i,n;for(n=e.rows,o=0,i=n.length;i>o;o++)s=n[o],Tangerine.$db.saveDoc($.extend(s.value,{old:!0}));return t.result.add(t.prototypeView.getResult(),function(){return Tangerine.router.navigate("class/"+t.options.student.get("klassId")+"/"+t.options.subtest.get("part"),!0)})}}(this)}):this.prototypeView.showErrors()},e}(Backbone.View);