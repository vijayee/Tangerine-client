var DashboardView,bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function n(){this.constructor=t}for(var s in e)hasProp.call(e,s)&&(t[s]=e[s]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;DashboardView=function(t){function e(){return this.renderResults=bind(this.renderResults,this),this.render=bind(this.render,this),this.update=bind(this.update,this),this.syntaxHighlight=bind(this.syntaxHighlight,this),this.showResult=bind(this.showResult,this),e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.prototype.className="DashboardView",e.prototype.events={"change #groupBy":"update","change #assessment":"update","change #shiftHours":"update","click .result":"showResult"},e.prototype.showResult=function(t){var e,n;return e=$("#resultDetails"),e.is(":visible")?e.hide():(n=$(t.target).text(),$.couch.db(document.location.pathname.match(/^\/(.*?)\//).pop()).openDoc(n,{success:function(n){return function(s){return e.html("<pre>"+n.syntaxHighlight(s)+"</pre>"),e.css({top:$(t.target).position().top+30,width:400,left:50}),e.show()}}(this)}))},e.prototype.syntaxHighlight=function(t){return window.json=t,"string"!=typeof t&&(t=JSON.stringify(t,void 0,2)),t=t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),t.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(t){var e;return e="number",/^"/.test(t)?e=/:$/.test(t)?"key":"string":/true|false/.test(t)?e="boolean":/null/.test(t)&&(e="null"),'<span class="'+e+'">'+t+"</span>"})},e.prototype.update=function(){return Tangerine.router.navigate("dashboard/groupBy/"+$("#groupBy").val()+"/assessment/"+$("#assessment").val()+"/shiftHours/"+$("#shiftHours").val(),!0)},e.prototype.render=function(){var t;return t=this.options,this.groupBy=t.groupBy,this.key=t.assessment,this.shiftHours=t.shiftHours||0,"All"===this.key?$.couch.db(Tangerine.db_name).view(Tangerine.design_doc+"/dashboardResults",{reduce:!1,success:this.renderResults}):$.couch.db(Tangerine.db_name).view(Tangerine.design_doc+"/dashboardResults",{key:this.key,reduce:!1,success:this.renderResults})},e.prototype.renderResults=function(t){var e,n,s;return s={},e={},n={},null==this.groupBy&&(this.groupBy=_.keys(t.rows[0].value)[0]),_.each(t.rows,function(t){return function(r){var o,i,u;return i=r.value[t.groupBy],u=r.value.startTime?moment(r.value.startTime).add("h",t.shiftHours).format("YYYYMMDD"):"Unknown",o=r.value.startTime?moment(r.value.startTime).add("h",t.shiftHours).format("Do MMM"):"Unknown",e[u]=o,null==s[i]&&(s[i]={}),null==s[i][u]&&(s[i][u]=[]),s[i][u].push("<div style='padding-top:10px;'> <table> "+_.map(r.value,function(e,s){return n[s]=!0,"startTime"===s&&(e=moment(e).add("h",t.shiftHours).format("YYYY-MM-DD HH:mm")),"resultId"===s&&(e="<button class='result'>"+e+"</button>"),"<tr><td>"+s+"</td><td>"+e+"</td></tr>"}).join("")+" </table> </div> <hr/>")}}(this)),this.$el.html("<h1>"+Tangerine.db_name+"</h1> Assessment: <select id='assessment'> </select> <br/> Value used for grouping: <select id='groupBy'> "+_.map(n,function(t){return function(e,n){return"<option "+(n===t.groupBy?"selected='true'":"")+"> "+n+" </option>"}}(this))+" </select> <br/> <br/> <button onClick='$(\"#advancedOptions\").toggle()'>Advanced Options</button> <div style='display:none' id='advancedOptions'> Current time in your timezone ("+jstz.determine().name()+") is "+moment().format("YYYY-MM-DD HH:mm")+"<br/> Shift time values by <input id='shiftHours' type='number' value='"+this.shiftHours+"'></input> hours to handle correct timezone.<br/> Shifted time: "+moment().add("h",this.shiftHours).format("YYYY-MM-DD HH:mm")+" <br/> </div> <table id='results' class='tablesorter'> <thead> <th>"+this.groupBy+"</th> "+_(e).keys().sort().map(function(t){return"<th class='"+t+"'>"+e[t]+"</th>"}).join("")+" </thead> <tbody> "+_.map(s,function(t,n){return"<tr> <td>"+n+"</td> "+_(e).keys().sort().map(function(e){return"<td class='"+e+"'> "+(t[e]?"<button class='sort-value' onClick='$(this).siblings().toggle()'>"+t[e].length+"</button> <div style='display:none'> "+t[e].join("")+" </div>":"")+" </td>"}).join("")+" </tr>"}).join("")+" </tbody> </table> <div id='resultDetails'> </div> <style> #resultDetails{ position:absolute; background-color:black; display:none; } pre { font-size: 75%; outline: 1px solid #ccc; padding: 5px; margin: 5px; text-shadow: none; overflow-wrap:break-word; } .string { color: green; } .number { color: darkorange; } .boolean { color: blue; } .null { color: magenta; } .key { color: red; } </style>"),this.$el.find("table#results").tablesorter({widgets:["zebra"],sortList:[[0,0]],textExtraction:function(t){var e;return e=$(t).find(".sort-value").text(),""!==e?e:$(t).text()}}),this.$el.find("#advancedOptions").append("Select which dates to show<br/>"),_(e).keys().sort().map(function(t){return function(n){var s,r;return r=e[n],s=$("<label for='"+n+"'>"+r+"</label><input name='"+n+"' id='"+n+"' type='checkbox' checked='true'/>"),s.click(function(){return $("."+n).toggle()}),t.$el.find("#advancedOptions").append(s)}}(this)),$.couch.db(Tangerine.db_name).view(Tangerine.design_doc+"/dashboardResults",{group:!0,success:function(t){return function(e){return $("select#assessment").html("<option>All</option>"+_.map(e.rows,function(e){return"<option value='"+e.key+"' "+(e.key===t.key?"selected='true'":"")+">"+e.key+"</option>"}).join("")),_.each(e.rows,function(t){return null!=t.key?$.couch.db(Tangerine.db_name).openDoc(t.key,{success:function(e){return $("option[value="+t.key+"]").html(e.name)},error:function(){return $("option[value="+t.key+"]").html("Unknown assessment")}}):void 0})}}(this)}),this.trigger("rendered")},e}(Backbone.View);