var SurveyRunView,bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function i(){this.constructor=t}for(var s in e)hasProp.call(e,s)&&(t[s]=e[s]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;SurveyRunView=function(e){function i(){return this.onQuestionRendered=bind(this.onQuestionRendered,this),this.getResult=bind(this.getResult,this),this.updateSkipLogic=bind(this.updateSkipLogic,this),this.onQuestionAnswer=bind(this.onQuestionAnswer,this),this.updateExecuteReady=bind(this.updateExecuteReady,this),i.__super__.constructor.apply(this,arguments)}return extend(i,e),i.prototype.className="SurveyRunView",i.prototype.events={"click .next_question":"nextQuestion","click .prev_question":"prevQuestion"},i.prototype.nextQuestion=function(){var t,e,i,s,n,o,r,u;if(t=this.questionViews[this.questionIndex],!this.isValid(t))return this.showErrors(t);for(i=[],u=this.questionViews,e=s=0,n=u.length;n>s;e=++s)r=u[e],r.isAutostopped||r.isSkipped||i.push(e);return i=_.filter(i,function(t){return function(e){return e>t.questionIndex}}(this)),o=0===i.length?this.questionIndex:Math.min.apply(o,i),this.questionIndex!==o?(this.questionIndex=o,this.updateQuestionVisibility(),this.updateProgressButtons()):void 0},i.prototype.prevQuestion=function(){var t,e,i,s,n,o,r,u;if(t=this.questionViews[this.questionIndex],!this.isValid(t))return this.showErrors(t);for(i=[],u=this.questionViews,e=s=0,n=u.length;n>s;e=++s)r=u[e],r.isAutostopped||r.isSkipped||i.push(e);return i=_.filter(i,function(t){return function(e){return e<t.questionIndex}}(this)),o=0===i.length?this.questionIndex:Math.max.apply(o,i),this.questionIndex!==o?(this.questionIndex=o,this.updateQuestionVisibility(),this.updateProgressButtons()):void 0},i.prototype.updateProgressButtons=function(){var t,e,i,s,n,o,r,u,h,p;for(s=[],p=this.questionViews,i=n=0,o=p.length;o>n;i=++n)h=p[i],h.isAutostopped||h.isSkipped||s.push(i);return s.push(this.questionIndex),e=this.$el.find(".prev_question"),t=this.$el.find(".next_question"),u=Math.min.apply(u,s),r=Math.max.apply(r,s),this.questionIndex===u?e.hide():e.show(),this.questionIndex===r?t.hide():t.show()},i.prototype.updateExecuteReady=function(t){var e,i,s,n,o;if(this.executeReady=t,null!=this.triggerShowList){if(this.triggerShowList.length>0){for(n=this.triggerShowList,i=0,s=n.length;s>i;i++)e=n[i],null!=(o=this.questionViews[e])&&o.trigger("show");this.triggerShowList=[]}return this.executeReady?this.updateSkipLogic():void 0}},i.prototype.updateQuestionVisibility=function(){var t;if(this.model.get("focusMode"))return this.questionIndex===this.questionViews.length?(this.$el.find("#summary_container").html("last page here"),this.$el.find("#next_question").hide()):(this.$el.find("#summary_container").empty(),this.$el.find("#next_question").show()),t=this.$el.find(".question"),t.hide(),t.eq(this.questionIndex).show(),this.executeReady?this.questionViews[this.questionIndex].trigger("show"):(this.triggerShowList||(this.triggerShowList=[]),this.triggerShowList.push(this.questionIndex))},i.prototype.showQuestion=function(t){return _.isNumber(t)&&t<this.questionViews.length&&t>0&&(this.questionIndex=t),this.updateQuestionVisibility(),this.updateProgressButtons()},i.prototype.i18n=function(){return this.text={pleaseAnswer:t("SurveyRunView.message.please_answer"),correctErrors:t("SurveyRunView.message.correct_errors"),notEnough:_(t("SurveyRunView.message.not_enough")).escape(),previousQuestion:t("SurveyRunView.button.previous_question"),nextQuestion:t("SurveyRunView.button.next_question")}},i.prototype.initialize=function(t){return this.model=t.model,this.parent=t.parent,this.dataEntry=t.dataEntry,this.isObservation=t.isObservation,this.focusMode=this.model.getBoolean("focusMode"),this.focusMode&&(this.questionIndex=0),this.questionViews=[],this.answered=[],this.renderCount=0,this.i18n(),this.questions=new Questions,this.questions.fetch({viewOptions:{key:"question-"+this.model.id},success:function(t){return function(){return t.questions.sort(),t.ready=!0,t.render()}}(this)})},i.prototype.onQuestionAnswer=function(){var t,e,i,s,n,o,r;if(this.renderCount===this.questions.length){if(this.autostopped=!1,e=this.model.getNumber("autostopLimit"),o=0,t=0,e>0)for(s=n=1,r=this.questionViews.length;r>=1?r>=n:n>=r;s=r>=1?++n:--n)i=this.questionViews[s-1].answer,"0"===i||"9"===i?t++:t=0,o=Math.max(o,t),0!==e&&o>=e&&!this.autostopped&&(this.autostopped=!0,this.autostopIndex=s);return this.updateAutostop(),this.updateSkipLogic()}},i.prototype.updateAutostop=function(){var t;return t=this.model.getNumber("autostopLimit"),this.questionViews.forEach(function(t,e){return e>this.autostopIndex-1?this.autostopped?(t.isAutostopped=!0,t.$el.addClass("disabled_autostop")):(t.isAutostopped=!1,t.$el.removeClass("disabled_autostop")):void 0},this)},i.prototype.updateSkipLogic=function(){return this.questionViews.forEach(function(t){var e,i,s,n,o,r,u;if(o=t.model,u=o.getString("skipLogic"),""!==u){try{r=CoffeeScript.eval.apply(this,[u])}catch(i){e=i,n=/function (.{1,})\(/.exec(e.constructor.toString())[1],s=e.message,alert("Skip logic error in question "+o.get("name")+"\n\n"+n+"\n\n"+s)}r?(t.$el.addClass("disabled_skipped"),t.isSkipped=!0):(t.$el.removeClass("disabled_skipped"),t.isSkipped=!1)}return t.updateValidity()},this)},i.prototype.isValid=function(t){return null==t&&(t=this.questionViews),null==t?!0:(_.isArray(t)||(t=[t]),t.forEach(function(t){return t.updateValidity(),t.model.getBoolean("skippable")||t.isValid?void 0:!1},this),!0)},i.prototype.getSkipped=function(){var t;return t={},this.questionViews.forEach(function(e,i){return t[this.questions.models[i].get("name")]="skipped"},this),t},i.prototype.getResult=function(){var t;return t={},this.questionViews.forEach(function(e,i){return t[this.questions.models[i].get("name")]=e.notAsked?e.notAskedResult:_.isEmpty(e.answer)?e.skipped?e.skippedResult:e.isSkipped?e.logicSkippedResult:e.isAutostopped?e.notAskedAutostopResult:e.answer:e.answer},this),t},i.prototype.showErrors=function(t){var e;return null==t&&(t=this.questionViews),this.$el.find(".message").remove(),e=!0,_.isArray(t)||(t=[t]),t.forEach(function(i,s){var n,o;return _.isString(i)?void 0:(o="",i.isValid||(n=i.model.get("customValidationMessage"),o=_.isEmpty(n)?this.text.pleaseAnswer:n,e===!0&&(t===this.questionViews&&this.showQuestion(s),i.$el.scrollTo(),Utils.midAlert(this.text.correctErrors),e=!1)),i.setMessage(o))},this)},i.prototype.render=function(){var t,e,i,s;if(this.ready)return this.$el.empty(),e=document.createDocumentFragment(),this.dataEntry||(s=this.parent.parent.result.getByHash(this.model.get("hash"))),i=0,this.questions.sort(),null!=this.questions.models&&(this.questions.models.forEach(function(t,n){var o,r,u,h,p;return p=t.getNumber("linkedGridScore"),r=(0!==p&&this.parent.getGridScore()<p||this.parent.gridWasAutostopped())&&this.parent.getGridScore()!==!1,r&&i++,u=t.escape("name").replace(/[^A-Za-z0-9_]/g,"-"),s&&(o=s[u]),h=new QuestionRunView({model:t,parent:this,dataEntry:this.dataEntry,notAsked:r,isObservation:this.isObservation,answer:o}),this.listenTo(h,"rendered",this.onQuestionRendered),this.listenTo(h,"answer scroll",this.onQuestionAnswer),this.questionViews[n]=h,e.appendChild(h.el)},this),this.questionViews.forEach(function(t){return t.render()}),this.focusMode&&(this.updateQuestionVisibility(),e.appendChild($("<div id='summary_container'></div> <button class='navigation prev_question'>"+this.text.previousQuestion+"</button> <button class='navigation next_question'>"+this.text.nextQuestion+"</button>")),this.updateProgressButtons())),this.questions.length===i&&("class"!==Tangerine.settings.get("context")?"function"==typeof(t=this.parent).next&&t.next():e.appendChild($("<p class='grey'>"+this.text.notEnough+"</p>"))),this.$el.append(e),this.trigger("rendered")},i.prototype.onQuestionRendered=function(){return this.renderCount++,this.renderCount===this.questions.length&&(this.trigger("ready"),this.updateSkipLogic()),this.trigger("subRendered")},i.prototype.onClose=function(){var t,e,i,s;for(s=this.questionViews,t=0,e=s.length;e>t;t++)i=s[t],"function"==typeof i.close&&i.close();return this.questionViews=[]},i}(Backbone.View);