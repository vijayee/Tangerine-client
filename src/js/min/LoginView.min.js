var LoginView,bind=function(e,t){return function(){return e.apply(t,arguments)}},extend=function(e,t){function s(){this.constructor=e}for(var n in t)hasProp.call(t,n)&&(e[n]=t[n]);return s.prototype=t.prototype,e.prototype=new s,e.__super__=t.prototype,e},hasProp={}.hasOwnProperty,indexOf=[].indexOf||function(e){for(var t=0,s=this.length;s>t;t++)if(t in this&&this[t]===e)return t;return-1};LoginView=function(e){function s(){return this.onClose=bind(this.onClose,this),this.afterRender=bind(this.afterRender,this),this.render=bind(this.render,this),this.recenter=bind(this.recenter,this),s.__super__.constructor.apply(this,arguments)}return extend(s,e),s.prototype.className="LoginView",s.prototype.events=Modernizr.touch?{"keypress input":"keyHandler","change input":"onInputChange","change select#name":"onSelectChange","click .mode":"updateMode","click button":"action","click .recent":"showRecent","blur .recent":"blurRecent","keyup #new_name":"checkNewName"}:{"keypress input":"keyHandler","change input":"onInputChange","change select#name":"onSelectChange","click .mode":"updateMode","click button":"action","click .recent":"showRecent","blur .recent":"blurRecent","keyup #new_name":"checkNewName"},s.prototype.initialize=function(e){return $(window).on("orientationchange scroll resize",this.recenter),this.mode="login",this.i18n(),this.users=e.users,this.user=Tangerine.user,this.listenTo(this.user,"login",this.goOn),this.listenTo(this.user,"pass-error",this.passError),this.listenTo(this.user,"name-error",this.nameError),this.oldBackground=$("body").css("background"),$("body").css("background","white"),$("#footer").hide()},s.prototype.checkNewName=function(e){var t,s;return t=$(e.target),s=t.val().toLowerCase()||"",s.length>4&&indexOf.call(this.users.pluck("name"),s)>=0?this.nameError(this.text.error_name_taken):this.clearErrors()},s.prototype.onInputChange=function(e){var t,s;return t=$(e.target),s=t.attr("type"),"text"===s||null==s?t.val(t.val().toLowerCase()):void 0},s.prototype.showRecent=function(){return this.$el.find("#name").autocomplete({source:this.user.recentUsers(),minLength:0}).autocomplete("search","")},s.prototype.blurRecent=function(){return this.$el.find("#name").autocomplete("close"),this.initAutocomplete()},s.prototype.initAutocomplete=function(){return this.$el.find("#name").autocomplete({source:this.users.pluck("name")})},s.prototype.recenter=function(){return this.$el.middleCenter()},s.prototype.i18n=function(){return this.text={login:t("LoginView.button.login"),sign_up:t("LoginView.button.sign_up"),login_tab:t("LoginView.label.login"),sign_up_tab:t("LoginView.label.sign_up"),user:_(t("LoginView.label.user")).escape(),teacher:_(t("LoginView.label.teacher")).escape(),enumerator:_(t("LoginView.label.enumerator")).escape(),password:t("LoginView.label.password"),password_confirm:t("LoginView.label.password_confirm"),error_name:t("LoginView.message.error_name_empty"),error_pass:t("LoginView.message.error_password_empty"),error_name_taken:t("LoginView.message.error_name_taken")}},s.prototype.onSelectChange=function(e){var t;return t=$(e.target),"*new"===t.val()?this.updateMode("signup"):this.$el.find("#pass").focus()},s.prototype.goOn=function(){return Tangerine.router.navigate("",!0)},s.prototype.updateMode=function(e){var t,s,n;switch(n=$(e.target),this.mode=n.attr("data-mode"),n.parent().find(".selected").removeClass("selected"),n.addClass("selected"),t=this.$el.find(".login"),s=this.$el.find(".signup"),this.mode){case"login":t.show(),s.hide();break;case"signup":t.hide(),s.show()}return this.$el.find("input")[0].focus()},s.prototype.render=function(){var e,t;return t=this.text.user,t=t.titleize(),e="<img src='images/login_logo.png' id='login_logo'> <div class='tab_container'> <div class='tab mode selected first' data-mode='login'>"+this.text.login_tab+"</div><div class='tab mode last' data-mode='signup'>"+this.text.sign_up_tab+"</div> </div> <div class='login'> <section> <div class='messages name_message'></div> <table><tr> <td><input id='name' class='tablet-name' placeholder='"+t+"'></td> <td><img src='images/icon_recent.png' class='recent clickable'></td> </tr></table> <div class='messages pass_message'></div> <input id='pass' type='password' placeholder='"+this.text.password+"'> <button class='login'>"+this.text.login+"</button> </section> </div> <div class='signup' style='display:none;'> <section> <div class='messages name_message'></div> <input id='new_name' class='tablet-name' type='text' placeholder='"+t+"'> <div class='messages pass_message'></div> <input id='new_pass_1' type='password' placeholder='"+this.text.password+"'> <input id='new_pass_2' type='password' placeholder='"+this.text.password_confirm+"'> <button class='sign_up'>"+this.text.sign_up+"</button> </section> </div>",this.$el.html(e),this.initAutocomplete(),this.nameMsg=this.$el.find(".name_message"),this.passMsg=this.$el.find(".pass_message"),this.trigger("rendered")},s.prototype.afterRender=function(){return this.recenter()},s.prototype.onClose=function(){return $("#footer").show(),$("body").css("background",this.oldBackground),$(window).off("orientationchange scroll resize",this.recenter)},s.prototype.keyHandler=function(e){var t,s,n;return n={ENTER:13,TAB:9,BACKSPACE:8},$(".messages").html(""),t=e.which,null==t?!0:(s=t===n.ENTER||e.keyCode===n.TAB||e.keyCode===n.BACKSPACE,/[a-zA-Z0-9]/.test(String.fromCharCode(t))||s?t===n.ENTER?this.action():void 0:!1)},s.prototype.action=function(){return"login"===this.mode&&this.login(),"signup"===this.mode&&this.signup(),!1},s.prototype.signup=function(){var e,t,s,n,i,r;return n=(e=this.$el.find("#new_name")).val().toLowerCase(),i=(t=this.$el.find("#new_pass_1")).val(),r=(s=this.$el.find("#new_pass_2")).val(),i!==r&&this.passError(this.text.pass_mismatch),this.user.signup(n,i)},s.prototype.login=function(){var e,t,s,n;return s=(e=this.$el.find("#name")).val(),n=(t=this.$el.find("#pass")).val(),this.clearErrors(),""===s&&this.nameError(this.text.error_name),""===n&&this.passError(this.text.error_pass),0===this.errors&&this.user.login(s,n),!1},s.prototype.passError=function(e){return this.errors++,this.passMsg.html(e),this.$el.find("#pass").focus()},s.prototype.nameError=function(e){return this.errors++,this.nameMsg.html(e),this.$el.find("#name").focus()},s.prototype.clearErrors=function(){return this.nameMsg.html(""),this.passMsg.html(""),this.errors=0},s}(Backbone.View);