var User,bind=function(n,e){return function(){return n.apply(e,arguments)}},extend=function(n,e){function t(){this.constructor=n}for(var r in e)hasProp.call(e,r)&&(n[r]=e[r]);return t.prototype=e.prototype,n.prototype=new t,n.__super__=e.prototype,n},hasProp={}.hasOwnProperty,indexOf=[].indexOf||function(n){for(var e=0,t=this.length;t>e;e++)if(e in this&&this[e]===n)return e;return-1};User=function(n){function e(){return this.fetch=bind(this.fetch,this),this.sessionRefresh=bind(this.sessionRefresh,this),this.login=bind(this.login,this),this.signup=bind(this.signup,this),e.__super__.constructor.apply(this,arguments)}return extend(e,n),e.prototype.url="user",e.prototype.initialize=function(){return this.myRoles=[],this.dbAdmins=[],this.myName=null},e.prototype.name=function(){return this.myName||null},e.prototype.roles=function(){return this.myRoles||null},e.prototype.recentUsers=function(){return($.cookie("recentUsers")||"").split(",")},e.prototype.signup=function(n,e){return Tangerine.log.app("User-signup",n),"server"===Tangerine.settings.get("context")?$.ajax({url:Tangerine.config.get("robbert"),type:"POST",dataType:"json",data:{action:"new_user",auth_u:n,auth_p:e},success:function(t){return function(){return"login"===t.intent?(t.intent="retry_login",t.login(n,e)):void 0}}(this)}):$.couch.signup({name:n},e,{success:function(t){return function(){return"login"===t.intent&&"class"===Tangerine.settings.get("context")&&"admin"!==n?$.couch.login({name:n,password:e,success:function(r){var s;return t.intent="",t.myName=n,t.myRoles=r.roles,s=new RegisterTeacherView({name:n,pass:e}),vm.show(s),Tangerine.log.app("User-teacher-register",n)}}):"login"===t.intent?(t.intent="retry_login",t.login(n,e)):void 0}}(this),error:function(n){return function(){return n.intent="",n.trigger("pass-error",t("LoginView.message.error_password_incorrect"))}}(this)})},e.prototype.login=function(n,e,r){return null==r&&(r={}),Tangerine.log.app("User-login-attempt",n),$.couch.login({name:n,password:e,success:function(e){return function(t){return e.intent="",e.myName=n,e.myRoles=t.roles,Tangerine.log.app("User-login-success",n),e.fetch({success:function(){var n;return"function"==typeof r.success&&r.success(),e.trigger("login"),n=e.recentUsers().filter(function(n){return!~n.indexOf(e.name())}),n.unshift(e.name()),n.length>=e.RECENT_USER_MAX&&n.pop(),$.cookie("recentUsers",n)}})}}(this),error:function(r){return function(){return"retry_login"===r.intent?(r.intent="",r.trigger("pass-error",t("LoginView.message.error_password_incorrect")),Tangerine.log.app("User-login-fail",n+" password incorrect")):(r.intent="login",r.signup(n,e))}}(this)})},e.prototype.sessionRefresh=function(n){return $.couch.session({success:function(e){return function(t){return null!=t.userCtx.name?(e.myName=t.userCtx.name,e.myRoles=t.userCtx.roles,e.fetch({success:function(){return e.trigger("login"),n.success.apply(e,arguments),Tangerine.log.app("User-login","Resumed session")}})):n.success.apply(e,arguments)}}(this),error:function(){return alert("Couch session error.\n\n"+arguments.join("\n"))}})},e.prototype.verify=function(n){return null===this.myName?null!=(null!=n?n.isUnregistered:void 0)?n.isUnregistered():Tangerine.router.navigate("login",!0):(null!=n&&"function"==typeof n.isAuthenticated&&n.isAuthenticated(),this.isAdmin()?null!=n&&"function"==typeof n.isAdmin?n.isAdmin():void 0:null!=n&&"function"==typeof n.isUser?n.isUser():void 0)},e.prototype.isAdmin=function(){var n;return n=this.myName,indexOf.call(this.dbAdmins,n)>=0||indexOf.call(this.myRoles,"_admin")>=0},e.prototype.logout=function(){return $.couch.logout({success:function(n){return function(){return $.cookie("AuthSession",null),n.myName=null,n.myRoles=[],n.clear(),n.trigger("logout"),"server"===Tangerine.settings.get("context")?window.location=Tangerine.settings.urlIndex("trunk"):Tangerine.router.navigate("login",!0),Tangerine.log.app("User-logout","logout")}}(this)})},e.prototype.save=function(n,e,t){var r;return r={},_.isObject(n)?(r=$.extend(r,n),t=e):r[n]=value,$.couch.userDb(function(n){return function(e){return e.saveDoc($.extend(n.attributes,r),{success:function(){var e;return null!=(e=t.success)?e.apply(n,arguments):void 0}})}}(this))},e.prototype.fetch=function(n){return null==n&&(n={}),$.couch.userDb(function(e){return function(t){return t.openDoc("org.couchdb.user:"+e.myName,{success:function(t){return Tangerine.$db.openDoc("_security",{success:function(r){var s,i,o;return e.dbAdmins=(null!=r&&null!=(s=r.admins)?s.names:void 0)||[],e.dbReaders=(null!=r&&null!=(i=r.members)?i.names:void 0)||[],e.dbReaders=_.filter(e.dbReaders,function(n){return"uploader"!==n.substr(0,8)}),e.set(t),null!=(o=n.success)&&o.apply(e,arguments),e.trigger("group-refresh")}})},error:function(){var t;return null!=(t=n.error)?t.apply(e,arguments):void 0}})}}(this))},e.prototype.joinGroup=function(n,e){return null==e&&(e={}),Utils.working(!0),Utils.passwordPrompt(function(t){return function(r){return Robbert.request({action:"new_group",group:n,auth_u:Tangerine.user.get("name"),auth_p:r,success:function(n){return Utils.working(!1),"success"===n.status&&(t.login(t.get("name"),r,{success:e}),t.trigger("group-join")),Utils.midAlert(n.message)},error:function(n){return Utils.working(!1),Utils.midAlert("Error creating group\n\n"+n[1]+"\n"+n[2]),t.fetch({success:e})}})}}(this))},e.prototype.leaveGroup=function(n,e){return null==e&&(e={}),Utils.working(!0),Utils.passwordPrompt(function(t){return function(r){return Robbert.request({action:"leave_group",user:t.get("name"),group:n,auth_u:Tangerine.user.get("name"),auth_p:r,success:function(n){return Utils.working(!1),t.login(t.get("name"),r,{success:e}),"success"===n.status&&t.trigger("group-leave"),Utils.midAlert(n.message)},error:function(n){return Utils.working(!1),Utils.midAlert(n.message),"function"==typeof e.error?e.error(n):void 0}})}}(this))},e.prototype.ghostLogin=function(n,e){var t;return Tangerine.log.db("User","ghostLogin"),t=encodeURIComponent(window.location.toString()),document.location=Tangerine.settings.location.group.url.replace(/\:\/\/.*@/,"://")+("_ghost/"+n+"/"+e+"/"+t)},e}(Backbone.Model);