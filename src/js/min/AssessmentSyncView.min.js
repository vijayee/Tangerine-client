var AssessmentSyncView,bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function n(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty,indexOf=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};AssessmentSyncView=function(t){function e(){return this.ensureCredentials=bind(this.ensureCredentials,this),this.verifyTimeout=bind(this.verifyTimeout,this),this.onVerifySuccess=bind(this.onVerifySuccess,this),this.getDocIds=bind(this.getDocIds,this),this.upload=bind(this.upload,this),this.download=bind(this.download,this),e.__super__.constructor.apply(this,arguments)}return extend(e,t),e.prototype.className="AssessmentSyncView",e.prototype.events={"click .back":"goBack","click .show_details":"showDetails","click .keep":"keep","click .show_login":"showLogin","click .login":"login","click .download":"download","click .upload":"upload"},e.prototype.download=function(){var t,e;return this.ensureCredentials(),t=Tangerine.settings.urlDB("group").replace(/\/\/(.*)@/,"//"+this.user+":"+this.pass+"@"),e=Tangerine.settings.urlDB("local"),this.getDocIds(function(n){return function(i){return $.couch.replicate(t,e,{success:function(){return Utils.midAlert("Download success"),n.updateConflicts()},error:function(t,e){return Utils.midAlert("Pull Error<br>"+t+" "+e)}},{doc_ids:i})}}(this))},e.prototype.upload=function(){var t,e;return this.ensureCredentials(),t=Tangerine.settings.urlDB("group").replace(/\/\/(.*)@/,"//"+this.user+":"+this.pass+"@"),e=Tangerine.settings.urlDB("local"),this.getDocIds(function(n){return function(i){return $.couch.replicate(e,t,{success:function(){return Utils.midAlert("Upload success"),n.updateConflicts()},error:function(t,e){return Utils.midAlert("Pull Error<br>"+t+" "+e)}},{doc_ids:i})}}(this))},e.prototype.getDocIds=function(t){var e,n,i,s;return e=Tangerine.settings.urlDB("group").replace(/\/\/(.*)@/,"//"),s=Tangerine.settings.urlDB("local"),i=Tangerine.settings.urlView("local","byDKey"),n=(Tangerine.settings.location.group.db+Tangerine.settings.couch.view+"byDKey").replace(/\/\/(.*)@/,"//"),$.ajax({url:n,type:"GET",dataType:"jsonp",data:{keys:JSON.stringify([this.dKey])},error:function(){return function(t,e){return Utils.midAlert("Pull error<br>"+t+" "+e)}}(this),success:function(e){return function(n){var s,r,o,a,u;for(r=[],u=n.rows,o=0,a=u.length;a>o;o++)s=u[o],r.push(s.id);return $.ajax({url:i,type:"POST",contentType:"application/json",dataType:"json",data:JSON.stringify({keys:[e.dKey]}),error:function(t,e){return Utils.midAlert("Pull error<br>"+t+" "+e)},success:function(e){var n,i,o;for(o=e.rows,n=0,i=o.length;i>n;n++)s=o[n],r.push(s.id);return r=_.uniq(r),t(r)}})}}(this)})},e.prototype.showLogin=function(){return this.$el.find("#user").val(""),this.$el.find("#pass").val(""),this.$el.find(".login_box").toggleClass("confirmation"),this.$el.find(".show_login").toggle()},e.prototype.onVerifySuccess=function(){return clearTimeout(this.timer),this.connectionVerified=!0,this.$el.find("#connection").html("Ok"),this.$el.find(".show_login").toggle(),this.$el.find(".loads").removeClass("confirmation")},e.prototype.login=function(){return this.user=this.$el.find("#user").val(),this.pass=this.$el.find("#pass").val(),Tangerine.settings.save({server_user:this.user,server_pass:this.pass}),Tangerine.user.ghostLogin(this.user,this.pass)},e.prototype.verifyTimeout=function(){return this.$el.find("#connection").html(this.loginButton({status:"<br>Failed. Check connection or try again."})),this.$el.find(".loads").addClass("confirmation"),this.removeCredentials()},e.prototype.keep=function(t){var e,n,i,s,r,o,a,u,l,c,d,h,p;if(confirm("This will permanently remove the other versions, are you sure?")){for(this.deletedCount=0,this.toDeleteCount=0,e=$(t.target),i=e.attr("data-docId"),s=e.attr("data-docRev"),r=_.indexBy("_id",this.loadedDocs),c=function(t){return function(){return t.deletedCount++,t.deletedCount===t.toDeleteCount?t.updateConflicts():void 0}}(this),d=r[i],o=0,u=d.length;u>o;o++)n=d[o],n._rev!==s&&this.toDeleteCount++;for(h=r[i],p=[],a=0,l=h.length;l>a;a++)n=h[a],n._rev!==s&&p.push(Tangerine.$db.removeDoc({_id:n._id,_rev:n._rev},{success:function(){return function(t){return c(t)}}(this),error:function(){return function(t,e){return Utils.alert("Error<br>"+t+"<br>"+e)}}(this)}));return p}},e.prototype.showDetails=function(t){var e,n;return e=$(t.target),n=e.attr("data-docRev"),this.$el.find("#table_"+n).toggleClass("confirmation")},e.prototype.initialize=function(t){return this.readyTemplates(),this.docList=[],this.assessment=t.assessment,this.dKey=this.assessment.id.substr(-5,5),this.connectionVerified=!1,this.timer=setTimeout(this.verifyTimeout,2e4),this.ensureCredentials()},e.prototype.ensureCredentials=function(){return Tangerine.settings.get("server_user")&&Tangerine.settings.get("server_pass")?(this.user=Tangerine.settings.get("server_user"),this.pass=Tangerine.settings.get("server_pass")):void 0},e.prototype.goBack=function(){return Tangerine.router.landing()},e.prototype.render=function(){var t,e;return e=this.assessment.getEscapedString("name"),"server"!==Tangerine.settings.get("context")&&(t="<div class='info_box grey'> Server connection<br> <span id='connection'>"+this.loginButton({status:"Checking..."})+"</span> </div>"),this.$el.html("<button class='back navigation'>Back</button> <h1>Assessment Sync</h1> <h2>"+e+"</h2> "+(t||"")+" <br> <div class='loads confirmation'> <div class='menu_box'> <button class='command upload'>Upload</button><br> <button class='command download'>Download</button> </div> </div> <h2>Conflicts</h2> <div id='conflicts'></div>"),this.updateConflicts(),this.trigger("rendered")},e.prototype.afterRender=function(){return this.user&&this.pass?$.ajax({url:Tangerine.settings.urlView("group","byDKey").replace(/\/\/(.*)@/,"//"+this.user+":"+this.pass+"@"),dataType:"jsonp",data:{keys:["testtest"]},timeout:15e3,success:function(t){return function(){return clearTimeout(t.timer),t.onVerifySuccess()}}(this)}):(clearTimeout(this.timer),this.verifyTimeout())},e.prototype.updateConflicts=function(){return Utils.working(!0),Tangerine.$db.view(Tangerine.design_doc+"/conflictsByDKey",{error:function(t,e){return Utils.midAlert("Error<br>"+t+"<br>"+e),Utils.working(!1)},success:function(t){return function(e){var n,i,s,r,o;if(Utils.working(!1),0===e.rows.length)return void t.$el.find("#conflicts").html("<div class='grey'>None</div>");for(t.loadedDocs=[],o=_.pluck(e.rows,"value"),s=function(e){var n,i,s,r,a,u,l,c,d,h,p,f,g,y,v,m,b,T;if(t.loadedDocs.push(e),b=o.length,t.loadedDocs.length===b){c="",u=_.indexBy("_id",t.loadedDocs),r=1;for(a in u){for(s=u[a],c+="<b>Document Conflict "+r+" "+s[0].collection.capitalize()+"</b>",n={},d=0,f=s.length;f>d;d++){v=s[d];for(p in v)T=v[p],null==n[p]&&(n[p]=[]),n[p].push(JSON.stringify(T))}i=[];for(p in n)T=n[p],_.uniq(T).length>1&&i.push(p);for(m=1,h=0,g=s.length;g>h;h++){v=s[h],y={};for(p in v)T=v[p],"_rev"!==p&&"_id"!==p&&"hash"!==p&&"updated"!==p&&"editedBy"!==p&&"assessmentId"!==p&&"curriculumId"!==p&&(y[p]=T);c+="<div class='menu_box'> <h3>Version "+m++ +"</h3> <table class='conflict_table'> <tr><td><b>"+v.name+"</b></td><td><button class='command keep' data-docId='"+v._id+"' data-docRev='"+v._rev+"'>Keep</button></td></tr> <tr><th>Updated</th><td>"+v.updated+"</td></tr> <tr><th>Edited by</th><td>"+v.editedBy+"</td></tr> </table> <button class='command show_details' data-docRev='"+v._rev+"'>Show details</button> <table class='confirmation conflict_table' id='table_"+v._rev+"'>";for(p in y)T=y[p],l=indexOf.call(i,p)>=0?"<b class='conflict_key'>"+p+"</b>":p,c+="<tr><th>"+l+"</th><td>"+JSON.stringify(T)+"</td></tr>";c+="</table> </div>"}r++}return t.$el.find("#conflicts").html(c)}},n=0,i=o.length;i>n;n++)r=o[n],$.ajax({url:"/"+Tangerine.db_name+"/"+r._id+"?rev="+r._rev,type:"get",dataType:"json",success:function(t){return s(t)}})}}(this)}),{}},e.prototype.onClose=function(){return clearTimeout(this.timer)},e.prototype.removeCredentials=function(){return Tangerine.settings.unset("server_user"),Tangerine.settings.unset("server_pass"),Tangerine.settings.save()},e.prototype.readyTemplates=function(){return this.loginButton=_.template("{{status}} <button class='command show_login'>Login</button><br> <div class='confirmation login_box'> <div> <label for='user'>Username</label><input id='user' type='text'><br> <label for='pass'>Password</label><input id='pass' type='password'> <button class='command login'>Login</button> </div> </div>")},e}(Backbone.View);