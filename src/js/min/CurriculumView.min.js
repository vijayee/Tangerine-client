var CurriculumView,extend=function(t,e){function s(){this.constructor=t}for(var r in e)hasProp.call(e,r)&&(t[r]=e[r]);return s.prototype=e.prototype,t.prototype=new s,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;CurriculumView=function(e){function s(){return s.__super__.constructor.apply(this,arguments)}return extend(s,e),s.prototype.className="CurriculumView",s.prototype.events={"click .back":"goBack","click .delete":"deleteCurriculum","click .delete_subtest":"deleteSubtest","click .edit_in_place":"editInPlace","click .new_subtest":"newSubtest","focusout .editing":"editing","keyup    .editing":"editing","keydown  .editing":"editing"},s.prototype.initialize=function(t){return this.curriculum=t.curriculum,this.subtests=t.subtests,this.questions=t.questions,this.questionsBySubtestId=this.questions.indexBy("subtestId"),this.totalAssessments=Math.max.apply(Math,this.subtests.pluck("part")),this.subtestsByPart=this.subtests.indexArrayBy("part"),this.subtestProperties={grid:[{key:"part",label:"Assessment",editable:!0},{key:"name",label:"Name",editable:!0,escaped:!0},{key:"timer",label:"Time<br>allowed",editable:!0},{key:"reportType",label:"Report",editable:!0},{key:"items",label:"Items",count:!0,editable:!0}],survey:[{key:"part",label:"Assessment",editable:!0},{key:"name",label:"Name",editable:!0},{key:"reportType",label:"Report",editable:!0}]}},s.prototype.render=function(){var e,s,r,i;return i=this.getSubtestTable(),e="server"===Tangerine.settings.get("context")?"<button class='command_red delete'>Delete</button>":"","server"===Tangerine.settings.get("context")&&(r="<button class='command new_subtest' data-prototype='grid'>New Grid Subtest</button><br> <button class='command new_subtest' data-prototype='survey'>New Survey Subtest</button>"),s="<button class='navigation back'>"+t("back")+"</button> <h1>"+this.options.curriculum.get("name")+"</h1> <div class='small_grey'>Download key <b>"+this.curriculum.id.substr(-5,5)+"</b></div> <div id='subtest_table_container'> "+i+" </div> "+(r||"")+" <br><br> "+e,this.$el.html(s),this.trigger("rendered")},s.prototype.updateTable=function(){return this.$el.find("#subtest_table_container").html(this.getSubtestTable())},s.prototype.getSubtestTable=function(){var t,e,s,r,i,n,a,u,o,l,c,d,p,b,g,y;s="<table class='subtests'>",s+="<tbody>",this.subtestsByPart=this.subtests.indexArrayBy("part"),p=this.subtestsByPart;for(o in p)for(y=p[o],s+="<tr><td>&nbsp;</td></tr>",r=0,a=y.length;a>r;r++){for(g=y[r],e=t="",b=this.subtestProperties[g.get("prototype")],n=0,u=b.length;u>n;n++)c=b[n],e+="<th>"+c.label+"</th>",t+=this.propCook(c,g);s+="<tr>"+e+"</tr>",s+="<tr>"+t,"server"===Tangerine.settings.get("context")&&(s+="<td> <a href='#class/subtest/"+g.id+"'><img class='link_icon edit' title='Edit' src='images/icon_edit.png'></a> <img class='link_icon delete_subtest' title='Delete' data-subtestId='"+g.id+"' src='images/icon_delete.png'> <a href='#class/run/test/"+g.id+"'><img class='link_icon testRun' title='Test run' src='images/icon_run.png'></a> </td> </tr>"),"grid"===g.get("prototype")&&(i=g.get("items").join(" "),s+="<tr><td colspan='"+this.subtestProperties.grid.length+"'>"+i+"</td></tr>"),"survey"===g.get("prototype")&&null!=this.questionsBySubtestId[g.id]&&(l=function(){var t,e,s,r;for(s=this.questionsBySubtestId[g.id],r=[],t=0,e=s.length;e>t;t++)d=s[t],r.push(d.get("prompt"));return r}.call(this).join(", "),s+="<tr><td colspan='"+this.subtestProperties.survey.length+"'>"+l+"</td></tr>")}return s+="</tbody> </table>"},s.prototype.propCook=function(t,e){var s,r,i;return i=null!=t.key?e.get(t.key):"&nbsp;",i=t.escape?e.escape(t.key):i,null!=t.count&&(i=i.length),null==i&&(i=""),s=t.editable&&"server"===Tangerine.settings.get("context")?"class='edit_in_place'":"",r=_.isNumber(i)?"data-isNumber='true'":"data-isNumber='false'","<td class='edit_in_place'><span data-subtestId='"+e.id+"' data-key='"+t.key+"' data-value='"+i+"' "+s+" "+r+">"+i+"</div></td>"},s.prototype.editInPlace=function(t){var e,s,r,i,n,a,u,o,l,c,d,p,b;if(!this.alreadyEditing&&(this.alreadyEditing=!0,e=$(t.target),("TD"!==e.prop("tagName")||(e=e.find("span"),0!==e.length))&&(r=e.parent(),this.$oldSpan=e.clone(),"TEXTAREA"!==e.prop("tagName"))))return a=Utils.guid(),o=e.attr("data-key"),u="true"===e.attr("data-isNumber"),p=e.attr("data-subtestId"),d=this.subtests.get(p),c=d.get(o),s=$(t.target),n=(s.attr("class")||"").replace("settings",""),l=s.css("margin"),"items"===o&&(c=c.join(" ")),b="data-isNumber='"+u+"' data-key='"+o+"' data-subtestId='"+p+"' ",r.html("<textarea id='"+a+"' "+b+" class='editing "+n+"' style='margin:"+l+"'>"+c+"</textarea>"),i=$("#"+a),i.focus()},s.prototype.editing=function(t){var e,s,r,i,n,a,u,o,l;return e=$(t.target),s=e.parent(),27===t.which||"focusout"===t.type?(e.remove(),s.html(this.$oldSpan),void(this.alreadyEditing=!1)):13!==t.which||"keydown"!==t.type?!0:(this.alreadyEditing=!1,n=e.attr("data-key"),i="true"===e.attr("data-isNumber"),l=e.attr("data-subtestId"),o=this.subtests.get(l),u=o.get(n),a=e.val(),a=i?parseInt(a):a,"items"===n&&(a=a.replace(/\s+/g," "),/\t|,/.test(a)&&alert('Please remember\n\nGrid items are space " " delimited'),a=_.compact(a.split(" "))),String(a)!==String(u)&&(r={},r[n]=a,o.save(r,{success:function(t){return function(){return Utils.midAlert("Subtest saved"),o.fetch({success:function(){return t.updateTable()}})}}(this),error:function(t){return function(){return o.fetch({success:function(){return t.updateTable(),alert("Please try to save again, it didn't work that time.")}})}}(this)})),!1)},s.prototype.goBack=function(){return"server"===Tangerine.settings.get("context")?Tangerine.router.navigate("assessments",!0):"class"===Tangerine.settings.get("context")?Tangerine.router.navigate("class",!0):void 0},s.prototype.deleteCurriculum=function(){return confirm("Delete curriculum\n"+this.curriculum.get("name")+"?")?this.curriculum.destroy(function(){return function(){return Tangerine.router.navigate("assessments",!0)}}(this)):void 0},s.prototype.newSubtest=function(t){var e,s,r,i,n;return r=$(t.target).attr("data-prototype"),e=Utils.guid(),n={_id:e,curriculumId:this.curriculum.id,prototype:r,captureLastAttempted:!1,endOfLine:!1},s=Tangerine.templates.get("prototypes"),n=$.extend(s[r],n),i=new Subtest(n),i.save(null,{success:function(){return Tangerine.router.navigate("class/subtest/"+e,!0)},error:function(){return alert("Please try again. There was a problem creating the new subtest.")}})},s.prototype.deleteSubtest=function(t){var e,s;return s=$(t.target).attr("data-subtestId"),e=this.subtests.get(s),confirm("Delete subtest\n"+e.get("name")+"?")?e.destroy({success:function(t){return function(){return t.subtests.remove(s),t.updateTable()}}(this),error:function(){return function(){return alert("Please try again, could not delete subtest.")}}(this)}):void 0},s}(Backbone.View);