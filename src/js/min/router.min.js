var Router,extend=function(e,t){function n(){this.constructor=e}for(var s in t)hasProp.call(t,s)&&(e[s]=t[s]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},hasProp={}.hasOwnProperty,indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};Router=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return extend(t,e),t.prototype.routes={login:"login",register:"register",logout:"logout",account:"account",transfer:"transfer",settings:"settings",update:"update","":"landing",logs:"logs","class":"klass","class/edit/:id":"klassEdit","class/student/:studentId":"studentEdit","class/student/report/:studentId":"studentReport","class/subtest/:id":"editKlassSubtest","class/question/:id":"editKlassQuestion","class/:id/:part":"klassPartly","class/:id":"klassPartly","class/run/:studentId/:subtestId":"runSubtest","class/result/student/subtest/:studentId/:subtestId":"studentSubtest",curricula:"curricula","curriculum/:id":"curriculum",curriculumImport:"curriculumImport","report/klassGrouping/:klassId/:part":"klassGrouping","report/masteryCheck/:studentId":"masteryCheck","report/progress/:studentId/:klassId":"progressReport",teachers:"teachers",groups:"groups",assessments:"assessments","run/:id":"run","print/:id/:format":"print","dataEntry/:id":"dataEntry","resume/:assessmentId/:resultId":"resume","restart/:id":"restart","edit/:id":"edit","results/:id":"results","import":"import","subtest/:id":"editSubtest","question/:id":"editQuestion",dashboard:"dashboard","dashboard/*options":"dashboard",admin:"admin","sync/:id":"sync"},t.prototype.admin=function(){return Tangerine.user.verify({isAdmin:function(){return $.couch.allDbs({success:function(){return function(e){var t,n;return t=e.filter(function(e){return 0===e.indexOf("group-")}),n=new AdminView({groups:t}),vm.show(n)}}(this)})}})},t.prototype.dashboard=function(e){var t,n;return e=null!=e?e.split(/\//):void 0,t={assessment:"All",groupBy:"enumerator"},_.each(e,function(n,s){return s%2?void 0:t[n]=e[s+1]}),n=new DashboardView,n.options=t,vm.show(n)},t.prototype.landing=function(e){var t;return null==e&&(e=!1),t=!e,Tangerine.router.navigate("assessments",t),e?document.location.reload():void 0},t.prototype.groups=function(){return Tangerine.user.verify({isAuthenticated:function(){var e;return e=new GroupsView,vm.show(e)}})},t.prototype.curricula=function(){return Tangerine.user.verify({isAuthenticated:function(){var e;return e=new Curricula,e.fetch({success:function(e){var t;return t=new CurriculaView({curricula:e}),vm.show(t)}})}})},t.prototype.curriculum=function(e){return Tangerine.user.verify({isAuthenticated:function(){var t;return t=new Curriculum({_id:e}),t.fetch({success:function(){var n;return n=new Subtests,n.fetch({success:function(){var s,r;return r=new Subtests(n.where({curriculumId:e})),s=new Questions,s.fetch({success:function(){var e,n;return e=[],r.each(function(t){return e=e.concat(s.where({subtestId:t.id}))}),e=new Questions(e),n=new CurriculumView({curriculum:t,subtests:r,questions:e}),vm.show(n)}})}})}})}})},t.prototype.curriculumEdit=function(e){return Tangerine.user.verify({isAuthenticated:function(){var t;return t=new Curriculum({_id:e}),t.fetch({success:function(){var n;return n=new Subtests,n.fetch({success:function(){var s,r,u,i,c;return i=n.where({curriculumId:e}),s=function(){var e,t,n;for(n=[],e=0,t=i.length;t>e;e++)u=i[e],n.push(u.get("part"));return n}(),r=Math.max.apply(Math,s),c=new CurriculumView({curriculum:t,subtests:i,parts:r}),vm.show(c)}})}})}})},t.prototype.curriculumImport=function(){return Tangerine.user.verify({isAuthenticated:function(){var e;return e=new AssessmentImportView({noun:"curriculum"}),vm.show(e)}})},t.prototype.klass=function(){return Tangerine.user.verify({isAuthenticated:function(){var e;return e=new Klasses,e.fetch({success:function(e){var t;return t=new Teachers,t.fetch({success:function(){var n;return n=new Curricula,n.fetch({success:function(n){var s;return Tangerine.user.isAdmin()||(e=new Klasses(e.where({teacherId:Tangerine.user.get("teacherId")}))),s=new KlassesView({klasses:e,curricula:n,teachers:t}),vm.show(s)}})}})}})}})},t.prototype.klassEdit=function(e){return Tangerine.user.verify({isAuthenticated:function(){var t;return t=new Klass({_id:e}),t.fetch({success:function(t){var n;return n=new Teachers,n.fetch({success:function(){var s;return s=new Students,s.fetch({success:function(s){var r,u;return r=new Students(s.where({klassId:e})),u=new KlassEditView({klass:t,students:r,allStudents:s,teachers:n}),vm.show(u)}})}})}})}})},t.prototype.klassPartly=function(e,t){return null==t&&(t=null),Tangerine.user.verify({isAuthenticated:function(){var n;return n=new Klass({_id:e}),n.fetch({success:function(){var s;return s=new Curriculum({_id:n.get("curriculumId")}),s.fetch({success:function(){var r;return r=new Students,r.fetch({success:function(r){var u,i;return i=new Students(r.where({klassId:e})),u=new KlassResults,u.fetch({success:function(r){var u,c;return c=new KlassResults(r.where({klassId:e})),u=new Subtests,u.fetch({success:function(e){var r,u;return r=new Subtests(e.where({curriculumId:n.get("curriculumId")})),u=new KlassPartlyView({part:t,subtests:r,results:c,students:i,curriculum:s,klass:n}),vm.show(u)}})}})}})}})}})}})},t.prototype.studentSubtest=function(e,t){return Tangerine.user.verify({isAuthenticated:function(){var n;return n=new Student({_id:e}),n.fetch({success:function(){var s;return s=new Subtest({_id:t}),s.fetch({success:function(){return Tangerine.$db.view(Tangerine.design_doc+"/resultsByStudentSubtest",{key:[e,t],success:function(r){var u;return u=new KlassResults,u.fetch({success:function(i){var c,o;return c=i.where({subtestId:t,studentId:e,klassId:n.get("klassId")}),o=new KlassSubtestResultView({allResults:u,results:c,subtest:s,student:n,previous:r.rows.length}),vm.show(o)}})}})}})}})}})},t.prototype.runSubtest=function(e,t){return Tangerine.user.verify({isAuthenticated:function(){var n;return n=new Subtest({_id:t}),n.fetch({success:function(){var s,r;return r=new Student({_id:e}),s=function(n,s){return n.fetch({success:function(){var r,u;return r=function(e,t,n,s){var r;return null==n&&(n=null),null==s&&(s={}),r=new KlassSubtestRunView({student:e,subtest:t,questions:u,linkedResult:s}),vm.show(r)},u=null,"survey"===s.get("prototype")?Tangerine.$db.view(Tangerine.design_doc+"/resultsByStudentSubtest",{key:[e,s.get("gridLinkId")],success:function(){return function(e){var i,c;return 0!==e.rows&&(i=new KlassResult(null!=(c=_.last(e.rows))?c.value:void 0)),u=new Questions,u.fetch({viewOptions:{key:"question-"+s.get("curriculumId")},success:function(){return u=new Questions(u.where({subtestId:t})),r(n,s,u,i)}})}}(this)}):r(n,s)}})},r.fetch("test"===e?{success:function(){return s(r,n)},error:function(){return r.save(null,{success:function(){return s(r,n)}})}}:{success:function(){return s(r,n)}})}})}})},t.prototype.register=function(){return Tangerine.user.verify({isUnregistered:function(){var e;return e=new RegisterTeacherView({user:new User}),vm.show(e)},isAuthenticated:function(){return Tangerine.router.landing()}})},t.prototype.studentEdit=function(e){return Tangerine.user.verify({isAuthenticated:function(){var t;return t=new Student({_id:e}),t.fetch({success:function(e){var t;return t=new Klasses,t.fetch({success:function(t){var n;return n=new StudentEditView({student:e,klasses:t}),vm.show(n)}})}})}})},t.prototype.dataEntry=function(e){return Tangerine.user.verify({isAdmin:function(){var t;return t=new Assessment({_id:e}),t.fetch({success:function(){var n;return n=new Questions,n.fetch({viewOptions:{key:"question-"+e},success:function(){var e,s;e=n.indexBy("subtestId");for(s in e)n=e[s],t.subtests.get(s).questions=new Questions(n);return vm.show(new AssessmentDataEntryView({assessment:t}))}})}})}})},t.prototype.sync=function(e){return Tangerine.user.verify({isAdmin:function(){var t;return t=new Assessment({_id:e}),t.fetch({success:function(){return vm.show(new AssessmentSyncView({assessment:t}))}})}})},t.prototype.assessments=function(){return Tangerine.user.verify({isAuthenticated:function(){var e;return e=new Assessments,e.fetch({success:function(){return vm.show(new AssessmentsMenuView({assessments:e}))}})}})},t.prototype.restart=function(e){return Tangerine.router.navigate("run/"+e,!0)},t.prototype.run=function(e){return Tangerine.user.verify({isAuthenticated:function(){var t;return t=new Assessment({_id:e}),t.deepFetch({success:function(){return vm.show(new AssessmentRunView({model:t}))}})}})},t.prototype.resume=function(e,t){return Tangerine.user.verify({isAuthenticated:function(){var n;return n=new Assessment({_id:e}),n.fetch({success:function(e){var n;return n=new Result({_id:t}),n.fetch({success:function(t){var n,s,r,u,i,c;for(c=new AssessmentRunView({model:e}),t.has("order_map")&&(r=t.get("order_map").slice(),c.orderMap=r),u=t.get("subtestData"),n=0,s=u.length;s>n;n++)i=u[n],null!=i.data&&null!=i.data.participant_id&&Tangerine.nav.setStudent(i.data.participant_id);return c.result=t,c.subtestViews.pop(),c.subtestViews.push(new ResultView({model:t,assessment:e,assessmentView:c})),c.index=t.get("subtestData").length,vm.show(c)}})}})}})},t.prototype.results=function(e){return Tangerine.user.verify({isAuthenticated:function(){var t;return t=new Assessment({_id:e}),t.fetch({success:function(){var n;return n=new Results,n.fetch({options:{key:"result-"+e},success:function(){var e;return console.log(n),e=new ResultsView({assessment:t,results:n.models}),vm.show(e)}})}})}})},t.prototype.csv=function(e){return Tangerine.user.verify({isAdmin:function(){var t;return t=new CSVView({assessmentId:e}),vm.show(t)}})},t.prototype.csv_alpha=function(e){return Tangerine.user.verify({isAdmin:function(){var t;return t=new Assessment({_id:e}),t.fetch({success:function(){var n;return n=t.get("name")+"-"+moment().format("YYYY-MMM-DD HH:mm"),document.location="/"+Tangerine.dbName+"/_design/"+Tangerine.designDoc+('/_list/csv/csvRowByResult?key="'+e+'"&filename='+n)}})},isUser:function(){var e;return e=new ErrorView({message:"You're not an admin user",details:"How did you get here?"}),vm.show(e)}})},t.prototype.klassGrouping=function(e,t){return t=parseInt(t),Tangerine.user.verify({isAuthenticated:function(){var n;return n=new Subtests,n.fetch({success:function(n){var s,r;return r=new Subtests(n.where({part:t})),s=new KlassResults,s.fetch({success:function(t){var n;return t=new KlassResults(t.where({klassId:e})),n=new Students,n.fetch({success:function(){var s,u,i,c,o,a,d,f,l;for(n=new Students(n.where({klassId:e})),f=n.pluck("_id"),d=[],c=t.models,u=0,i=c.length;i>u;u++)a=c[u],o=a.get("studentId"),indexOf.call(f,o)>=0&&d.push(a);return s=new KlassResults(d),l=new KlassGroupingView({students:n,subtests:r,results:s}),vm.show(l)}})}})}})}})},t.prototype.masteryCheck=function(e){return Tangerine.user.verify({isAuthenticated:function(){var t;return t=new Student({_id:e}),t.fetch({success:function(t){var n,s;return s=t.get("klassId"),n=new Klass({_id:t.get("klassId")}),n.fetch({success:function(n){var r;return r=new KlassResults,r.fetch({success:function(r){var u,i,c,o,a,d,f,l,w,h;for(f=new KlassResults(r.where({studentId:e,reportType:"mastery",klassId:s})),h={},a=f.models,u=0,c=a.length;c>u;u++)d=a[u],h[d.get("subtestId")]=!0;for(h=_.keys(h),l=new Subtests,i=0,o=h.length;o>i;i++)w=h[i],l.add(new Subtest({_id:w}));return l.fetch({success:function(){var e;return e=new MasteryCheckView({student:t,results:f,klass:n,subtests:l}),vm.show(e)}})}})}})}})}})},t.prototype.progressReport=function(e,t){return Tangerine.user.verify({isAuthenticated:function(){var n,s,r;return n=function(e,n){var s;return s=new Klass({_id:t}),s.fetch({success:function(s){var r;return r=new Subtests,r.fetch({success:function(r){var u,i;return i=new Subtests(r.where({curriculumId:s.get("curriculumId"),reportType:"progress"})),u=new KlassResults,u.fetch({success:function(r){var u,c,o,a,d,f,l,w,h;if(f=new KlassResults(r.where({klassId:t,reportType:"progress"})),console.log(n),null!=n){for(w=n.pluck("_id"),l=[],o=f.models,u=0,c=o.length;c>u;u++)d=o[u],a=d.get("studentId"),indexOf.call(w,a)>=0&&l.push(d);f=new KlassResults(l)}return h=new ProgressView({subtests:i,student:e,results:f,klass:s}),vm.show(h)}})}})}})},"all"!==e?(s=new Student({_id:e}),s.fetch({success:function(){return n(s)}})):(r=new Students,r.fetch({success:function(){return n(null,r)}}))}})},t.prototype.editSubtest=function(e){return Tangerine.user.verify({isAdmin:function(){var t;return e=Utils.cleanURL(e),t=new Subtest({_id:e}),t.fetch({success:function(e){var n;return n=new Assessment({_id:t.get("assessmentId")}),n.fetch({success:function(){var t;return t=new SubtestEditView({model:e,assessment:n}),vm.show(t)}})}})},isUser:function(){return Tangerine.router.landing()}})},t.prototype.editKlassSubtest=function(e){var t;return t=function(e,t,n){var s;return null==n&&(n=null),s=new KlassSubtestEditView({model:e,curriculum:t,questions:n}),vm.show(s)},Tangerine.user.verify({isAdmin:function(){var n;return e=Utils.cleanURL(e),n=new Subtest({_id:e}),n.fetch({success:function(){var e;return e=new Curriculum({_id:n.get("curriculumId")}),e.fetch({success:function(){var s;return"survey"===n.get("prototype")?(s=new Questions,s.fetch({viewOptions:{key:"question-"+e.id},success:function(){return s=new Questions(s.where({subtestId:n.id})),t(n,e,s)}})):t(n,e)}})}})},isUser:function(){return Tangerine.router.landing()}})},t.prototype.editQuestion=function(e){return Tangerine.user.verify({isAdmin:function(){var t;return e=Utils.cleanURL(e),t=new Question({_id:e}),t.fetch({success:function(e){var t;return t=new Assessment({_id:e.get("assessmentId")}),t.fetch({success:function(){var n;return n=new Subtest({_id:e.get("subtestId")}),n.fetch({success:function(){var s;return s=new QuestionEditView({question:e,subtest:n,assessment:t}),vm.show(s)}})}})}})},isUser:function(){return Tangerine.router.landing()}})},t.prototype.editKlassQuestion=function(e){return Tangerine.user.verify({isAdmin:function(){var t;return e=Utils.cleanURL(e),t=new Question({_id:e}),t.fetch({success:function(e){var t;return t=new Curriculum({_id:e.get("curriculumId")}),t.fetch({success:function(){var n;return n=new Subtest({_id:e.get("subtestId")}),n.fetch({success:function(){var s;return s=new QuestionEditView({question:e,subtest:n,assessment:t}),vm.show(s)}})}})}})}})},t.prototype.login=function(){return Tangerine.user.verify({isAuthenticated:function(){return Tangerine.router.landing()},isUnregistered:function(){var e;return e=new TabletUsers,e.fetch({success:function(){return vm.show(new LoginView({users:e}))}})}})},t.prototype.logout=function(){return Tangerine.user.logout()},t.prototype.account=function(){return Tangerine.user.verify({isAuthenticated:function(){var e,t;return e=function(e){var t;return t=new AccountView({user:Tangerine.user,teacher:e}),vm.show(t)},"class"===Tangerine.settings.get("context")?Tangerine.user.has("teacherId")?(t=new Teacher({_id:Tangerine.user.get("teacherId")}),t.fetch({success:function(){return e(t)}})):(t=new Teacher({_id:Utils.humanGUID()}),t.save(null,{success:function(){return e(t)}})):e()}})},t.prototype.settings=function(){return Tangerine.user.verify({isAuthenticated:function(){var e;return e=new SettingsView,vm.show(e)}})},t.prototype.logs=function(){return Tangerine.user.verify({isAuthenticated:function(){var e;return e=new Logs,e.fetch({success:function(){return function(){var t;return t=new LogView({logs:e}),vm.show(t)}}(this)})}})},t.prototype.teachers=function(){return Tangerine.user.verify({isAuthenticated:function(){var e;return e=new TabletUsers,e.fetch({success:function(){var t;return t=new Teachers,t.fetch({success:function(){return function(){var n;return n=new TeachersView({teachers:t,users:e}),vm.show(n)}}(this)})}})}})},t.prototype.transfer=function(){var e,t;return e=Utils.$_GET(),t=e.name,$.couch.logout({success:function(){return function(){return $.cookie("AuthSession",null),$.couch.login({name:t,password:t,success:function(){return Tangerine.router.landing(),window.location.reload()},error:function(){return $.couch.signup({name:t,roles:["_admin"]},t,{success:function(){var e;return e=new User,e.save({name:t,id:"tangerine.user:"+t,roles:[],from:"tc"},{wait:!0,success:function(){return $.couch.login({name:t,password:t,success:function(){return Tangerine.router.landing(),window.location.reload()},error:function(){return Utils.sticky("Error transfering user.")}})}})}})}})}}(this)})},t}(Backbone.Router);