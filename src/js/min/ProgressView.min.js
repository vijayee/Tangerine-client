var ProgressView,SortedCollection,bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function s(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return s.prototype=e.prototype,t.prototype=new s,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;ProgressView=function(e){function s(){return this.updateFlot=bind(this.updateFlot,this),this.afterRender=bind(this.afterRender,this),s.__super__.constructor.apply(this,arguments)}return extend(s,e),s.prototype.className="ProgressView",s.prototype.INDIVIDUAL=1,s.prototype.AGGREGATE=2,s.prototype.events={"click .back":"goBack","click .select_itemType":"selectItemType","click .xtick":"selectAssessment"},s.prototype.selectAssessment=function(t){return this.selected.week=parseInt($(t.target).attr("data-index")),this.updateTable(),this.updateFlot()},s.prototype.selectItemType=function(t){var e;return e=$(t.target),this.selected.itemType=e.attr("data-itemType"),this.$el.find(".select_itemType").removeClass("selected"),e.addClass("selected"),this.updateTable(),this.updateFlot()},s.prototype.goBack=function(){return history.go(-1)},s.prototype.initialize=function(t){var e,s,i,r,a,n,o,h,l,d,p,c,u,m,g,y,f,b,k,w,T,v,x,P,B,N,I,D,M,C,L,A,R,G,$,S,V,E,F,O,U,z;if(this.results=t.results,this.student=t.student,this.subtests=t.subtests,this.klass=t.klass,null==this.klass&&Utils.log(this,"No klass."),null==this.subtests&&Utils.log(this,"No progress type subtests."),0===this.results.length)return this.renderReady=!0,void this.render();for(this.mode=null!=this.student?this.INDIVIDUAL:this.AGGREGATE,this.subtestNames={},this.benchmarkScore={},this.rows=[],this.partCount=0,this.flot=null,this.lastPart=Math.max.apply(this,_.compact(this.subtests.pluck("part"))),this.resultsByPart=[],this.itemTypeList={},this.selected={itemType:null,week:0},N=[],C=this.subtests.models,o=0,p=C.length;p>o;o++)O=C[o],~N.indexOf(O.get("part"))||N.push(O.get("part")),r=N.indexOf(O.get("part")),null==this.subtestNames[r]&&(this.subtestNames[r]={}),this.subtestNames[r][O.get("itemType")]=O.get("name");for(this.partCount=N.length,z=this.subtests.indexBy("part"),B=_.keys(z),this.indexByPart=[],r=h=0,c=B.length;c>h;r=++h)P=B[r],this.indexByPart[P]=r;for(this.resultsByPart=this.results.indexBy("part"),L=this.results.models,d=0,u=L.length;u>d;d++)E=L[d],this.itemTypeList[E.get("itemType").toLowerCase()]=!0;for(this.itemTypeList=_.keys(this.itemTypeList),P=k=1,A=this.lastPart;A>=1?A>=k:k>=A;P=A>=1?++k:--k)if(void 0!==this.resultsByPart[P]){for(n={},R=this.resultsByPart[P],r=w=0,m=R.length;m>w;r=++w)E=R[r],(this.mode!==this.INDIVIDUAL||E.get("studentId")===this.student.id)&&(a=E.get("itemType"),null==this.selected.itemType&&(this.selected.itemType=a),null==n[a]&&(n[a]=[]),n[a].push({name:a.titleize(),key:a,part:E.get("part"),correct:E.get("correct"),attempted:E.get("attempted"),itemsPerMinute:E.getCorrectPerSeconds(60)}),this.benchmarkScore[a]=this.subtests.get(E.get("subtestId")).getNumber("scoreTarget"));this.rows.push({part:P,itemTypes:_.values(n)})}for(this.rows=this.aggregate(this.rows),0!==this.rows.length&&(this.selected={week:this.indexByPart[_.last(this.rows).part],itemType:_.last(this.rows).itemTypes[0].key}),I={},G=this.rows,r=v=0,g=G.length;g>v;r=++v)for(F=G[r],$=F.itemTypes,x=0,y=$.length;y>x;x++)a=$[x],i=this.indexByPart[F.part]+1,null==I[a.key]&&(I[a.key]=[]),I[a.key].push([i,a.itemsPerMinute]);this.flotData=[],this.benchmarkData=[],r=0;for(T in I)e=I[T],l=T.toLowerCase(),this.flotData[l]={data:e,label:T.titleize(),key:l,lines:{show:!0},points:{show:!0}};this.flotBenchmark=[],S=this.subtests.indexBy("itemType");for(a in S){for(U=S[a],s=[],r=D=0,f=U.length;f>D;r=++D)O=U[r],i=this.indexByPart[O.get("part")]+1,s.push([i,O.getNumber("scoreTarget")]);this.flotBenchmark[a.toLowerCase()]={label:"Progress benchmark",data:s,color:"#aaa",lines:{show:!0}}}this.warningThresholds={},V=this.subtests.indexBy("itemType");for(a in V)for(U=V[a],this.warningThresholds[a]=[],r=M=0,b=U.length;b>M;r=++M)O=U[r],this.warningThresholds[a.toLowerCase()][this.indexByPart[O.get("part")]]={target:O.getNumber("scoreTarget"),spread:O.getNumber("scoreSpread"),seconds:O.getNumber("timer")};return this.renderReady=!0,this.render()},s.prototype.render=function(){var e,s,i,r,a,n,o,h,l,d,p;if(this.renderReady){if(e=$(window),p={h:e.height(),w:e.width()},this.mode===this.INDIVIDUAL&&(d="<h2>"+this.student.get("name")+"</h2>"),s="<h1>Progress table</h1> "+(d||""),i="<p>No test data for this type of report. Return to the <a href='#class'>class menu</a> and click the <img src='images/icon_run.png'> icon to collect data.</p>",0===this.results.length)return this.$el.html(s+" "+i),void this.trigger("rendered");for(s+="<div id='flot-menu'>",h=_.uniq(this.subtests.pluck("itemType")),r=0,o=h.length;o>r;r++)a=h[r],n=a.replace(/[_-]/g," ").capitalize(),l=a===this.selected.itemType?"selected":"",s+="<button class='command select_itemType "+l+"' data-itemType='"+a+"'>"+n+"</button>";return s+="</div> <div id='flot-container' style='width: "+.8*window.w+"px; height:300px;'></div>",s+="<div id='table_container'></div> <button class='navigation back'>"+t("back")+"</button>",this.$el.html(s),this.updateTable(),this.trigger("rendered")}},s.prototype.afterRender=function(){return this.updateFlot()},s.prototype.updateTable=function(){var t,e,s,i,r,a,n,o,h,l,d,p,c,u,m,g,y,f,b,k,w,T,v,x,P;for(v=this.selected.itemType,P=this.selected.week,a="<table class='tabular'>",g=this.rows,n=h=0,p=g.length;p>h;n=++h)if(k=g[n],~_.pluck(k.itemTypes,"key").indexOf(v))for(a+="<tr><th>"+this.subtestNames[n][v]+"</th></tr><tr>",y=k.itemTypes,l=0,c=y.length;c>l;l++)o=y[l],o.key===v&&(a+="<tr> <td>"+o.name+" correct</td><td>"+o.correct+"/"+o.attempted+"</td> </tr> <tr> <td>"+o.name+" correct per minute</td><td>"+o.itemsPerMinute+"</td> </tr>");if(a+="</table>",t=_.pluck(null!=(f=this.rows[P])?f.itemTypes:void 0,"key"),P>=this.rows.length||!~t.indexOf(v))a+="<section>No data for this assessment.</section>";else if(this.mode===this.AGGREGATE){for(w=0,e=null!=this.flotData[v]?this.flotData[v].data:[],d=0,u=e.length;u>d;d++)s=e[d],s[0]===P+1&&(w=s[1]);T=this.warningThresholds[v][P],r=T.target+T.spread,m=T.target-T.spread,i=w-T.target,w>r?(b="("+w+"), "+i+" correct items per minute above the benchmark",x="Your class is doing well, "+b+", continue with the reading program. Share your and your class\u2019 great work with parents. Reward your class with some fun reading activities such as reading marathons or competitions. However, look at a student grouping report for this assessment and make sure that those children performing below average get extra attention and practice and don\u2019t fall behind."):m>w?(b="("+w+"), "+Math.abs(i)+" correct items per minute below the benchmark",x="Your class is performing below the grade-level target, "+b+". Plan for additional lesson time focusing on reading in consultation with your principal. Encourage parents to spend more time with reading materials at home \u2013 remind them that you are a team working together to help their children learning to read. Think about organizing other events and opportunities for practice, e.g., reading marathons or competitions to motivate students to read more."):(b=0!==i&&-1*i===Math.abs(i)?w-T.target+" correct items per minute above the bench mark":0===i?w+" correct items per minute":"("+w+"), "+Math.abs(w-T.target)+" correct items per minute below the bench mark",x="Your class is in line with expectations, "+b+". Continue with the reading program and keep up the good work! Look at a student grouping report for this assessment and make sure that those children performing below average get extra attention and practice and don\u2019t fall behind."),a+="<section> "+x+" </section>"}return this.$el.find("#table_container").html(a)},s.prototype.updateFlot=function(){var t,e;return this.flotOptions={xaxis:{min:.5,max:this.partCount+.5,ticks:function(){var t,s,i;for(i=[],e=t=1,s=this.partCount;s>=1?s>=t:t>=s;e=s>=1?++t:--t)i.push(String(e));return i}.call(this),tickDecimals:0,tickFormatter:function(t){return function(e){return null!=t.subtestNames[e-1][t.selected.itemType]?"<button class='xtick "+(e-1===t.selected.week?"selected":"")+"' data-index='"+(e-1)+"'>"+t.subtestNames[e-1][t.selected.itemType]+"</button>":""}}(this)},grid:{markings:{color:"#ffc",xaxis:{to:this.selected.week+.5,from:this.selected.week-.5}}}},t=[],this.flotData[this.selected.itemType]&&t.push(this.flotData[this.selected.itemType]),this.flotBenchmark[this.selected.itemType]&&t.push(this.flotBenchmark[this.selected.itemType]),this.flot=$.plot(this.$el.find("#flot-container"),t,this.flotOptions)},s.prototype.aggregate=function(t){var e,s,i,r,a,n,o,h,l,d,p,c,u;for(l=[],e=s=0,a=t.length;a>s;e=++s)for(u=t[e],l[e]={part:u.part,itemTypes:[]},d=u.itemTypes,i=0,n=d.length;n>i;i++){for(c=d[i],h={name:"",key:"",correct:0,attempted:0,itemsPerMinute:0},r=0,o=c.length;o>r;r++)p=c[r],h.name=p.name,h.key=p.key,h.correct+=p.correct,h.attempted+=p.attempted,h.itemsPerMinute+=p.itemsPerMinute;h.correct/=c.length,h.attempted/=c.length,h.itemsPerMinute/=c.length,h.correct=Math.round(h.correct),h.attempted=Math.round(h.attempted),h.itemsPerMinute=Math.round(h.itemsPerMinute),l[e].itemTypes.push(h)}return l},s}(Backbone.View),SortedCollection=function(){function t(t){this.sorted=[],this.models=t.models,this.attribute=t.attribute}return t}();