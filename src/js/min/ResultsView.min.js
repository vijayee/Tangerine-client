var ResultsView,bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function s(){this.constructor=t}for(var i in e)hasProp.call(e,i)&&(t[i]=e[i]);return s.prototype=e.prototype,t.prototype=new s,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;ResultsView=function(e){function s(){return this.afterRender=bind(this.afterRender,this),this.updateResults=bind(this.updateResults,this),this.updateOptions=bind(this.updateOptions,this),this.detectTablets=bind(this.detectTablets,this),s.__super__.constructor.apply(this,arguments)}return extend(s,e),s.prototype.className="ResultsView",s.prototype.events={"click .cloud":"cloud","click .tablets":"tablets","click .detect":"detectOptions","click .details":"showResultSumView","change #limit":"setLimit","change #page":"setOffset"},s.prototype.showResultSumView=function(t){var e,s,i;return i=$(t.target).attr("data-result-id"),e=this.$el.find("#details_"+i),""!==e.html()?e.empty():(s=new Result({_id:i}),s.fetch({success:function(){var t;return t=new ResultSumView({model:s,finishCheck:!0}),t.render(),e.html("<div class='info_box'>"+$(t.el).html()+"</div>"),t.close()}}))},s.prototype.cloud=function(){var t;return t=Tangerine.settings.urlDB("group",!0)+"/_all_docs",console.log(t),$.ajax({url:t,type:"POST",data:JSON.stringify({keys:this.docList}),beforeSend:function(t){return console.log("setting to"),console.log("Basic "+btoa("tangerine:tangytangerine")),t.setRequestHeader("Authorization","Basic "+btoa(Tangerine.settings.get("upUser")+":"+Tangerine.settings.get("upPass")))},error:function(){return function(t){return console.log(t)}}(this),success:function(t){return function(t){var e,s,i,n,l;for(l=t.rows,s=[],e=0,i=l.length;i>e;e++)n=l[e],null==n.id&&s.push(n.key);Tangerine.db.allDocs({include_docs:!0,keys:s}).then(function(){return console.log(arguments)})}}(this)}),this.available.cloud.ok?(console.log("going here "+Tangerine.settings.urlDB("group",!0)),void $.ajax({url:Tangerine.settings.urlDB("group",!0)+"/_all_docs",ajax:{cache:!1,timeout:3e4,data:{keys:this.docList}},auth:{username:Tangerine.settings.get("upUser"),password:Tangerine.settings.get("upPass")}}).then(function(){return console.log(arguments)})):(Utils.midAlert("Cannot detect cloud"),!1)},s.prototype.tablets=function(){var t,e,s,i,n;if(this.available.tablets.okCount>0)for(n=this.available.tablets.ips,t=function(t){return function(e){return $.couch.replicate(Tangerine.settings.urlDB("local"),Tangerine.settings.urlSubnet(e),{success:function(){return t.$el.find(".status").find(".info_box").html("Results synced to "+t.available.tablets.okCount+" successfully")},error:function(e,s){return t.$el.find(".status").find(".info_box").html("<div>Sync error</div><div>"+e+" "+s+"</div>")}},{doc_ids:t.docList})}}(this),e=0,i=n.length;i>e;e++)s=n[e],t(s);else Utils.midAlert("Cannot detect tablets");return!1},s.prototype.initDetectOptions=function(){return this.available={cloud:{ok:!1,checked:!1},tablets:{ips:[],okCount:0,checked:0,total:256}}},s.prototype.detectOptions=function(){return $("button.cloud, button.tablets").attr("disabled","disabled"),this.detectCloud(),this.detectTablets()},s.prototype.detectCloud=function(){return $.ajax({type:"GET",dataType:"json",url:Tangerine.settings.urlHost("group"),success:function(t){return function(){return console.log("cloudy"),t.available.cloud.ok=!0}}(this),error:function(t){return function(){return console.log("error man"),t.available.cloud.ok=!1}}(this),complete:function(t){return function(){return console.log("complete at least"),t.available.cloud.checked=!0,t.updateOptions()}}(this)})},s.prototype.detectTablets=function(){var t,e,s;for(s=[],e=t=0;255>=t;e=++t)s.push(function(t){return function(e){var s;return s=Tangerine.settings.subnetIP(e),$.ajax({url:Tangerine.settings.urlSubnet(s),dataType:"jsonp",contentType:"application/json;charset=utf-8",timeout:3e4,complete:function(e){return t.available.tablets.checked++,200===e.status&&(t.available.tablets.okCount++,t.available.tablets.ips.push(s)),t.updateOptions()}})}}(this)(e));return s},s.prototype.updateOptions=function(){var t,e,s;return e=Math.decimals(this.available.tablets.checked/this.available.tablets.total*100,2),t=100===e?"finished":e+"%",s="Searching for tablets: "+t,this.available.tablets.checked>0&&this.$el.find(".checking_status").html(""+s),this.available.cloud.checked&&this.available.tablets.checked===this.available.tablets.total&&(this.$el.find(".status .info_box").html("Done detecting options"),this.$el.find(".checking_status").hide()),this.available.cloud.ok&&this.$el.find("button.cloud").removeAttr("disabled"),this.available.tablets.okCount>0&&100===e?this.$el.find("button.tablets").removeAttr("disabled"):void 0},s.prototype.i18n=function(){return this.text={saveOptions:t("ResultsView.label.save_options"),cloud:t("ResultsView.label.cloud"),tablets:t("ResultsView.label.tablets"),csv:t("ResultsView.label.csv"),started:t("ResultsView.label.started"),results:t("ResultsView.label.results"),details:t("ResultsView.label.details"),page:t("ResultsView.label.page"),status:t("ResultsView.label.status"),perPage:t("ResultsView.label.par_page"),noResults:t("ResultsView.message.no_results"),detect:t("ResultsView.button.detect")}},s.prototype.initialize=function(t){var e,s,i,n;for(this.i18n(),this.resultLimit=100,this.resultOffset=0,this.subViews=[],this.results=t.results,this.assessment=t.assessment,this.docList=[],i=this.results,e=0,s=i.length;s>e;e++)n=i[e],this.docList.push(n.get("_id"));return this.initDetectOptions(),this.detectCloud()},s.prototype.render=function(){var t;return this.clearSubViews(),t="<h1>"+this.assessment.getEscapedString("name")+" "+this.text.results+"</h1> <h2>"+this.text.saveOptions+"</h2> <div class='menu_box'> <button class='cloud command' disabled='disabled'>"+this.text.cloud+"</button> <button class='tablets command' disabled='disabled'>"+this.text.tablets+"</button> </div> <button class='detect command'>"+this.text.detect+"</button> <div class='status'> <h2>"+this.text.status+"</h2> <div class='info_box'></div> <div class='checking_status'></div> </div> <h2 id='results_header'>"+this.text.results+" (<span id='result_position'>loading...</span>)</h2> <div class='confirmation' id='controls'> <label for='page' class='small_grey'>"+this.text.page+"</label><input id='page' type='number' value='0'> <label for='limit' class='small_grey'>"+this.text.perPage+"</label><input id='limit' type='number' value='0'> </div> <section id='results_container'></section>",this.$el.html(t),this.updateResults(),this.trigger("rendered")},s.prototype.setLimit=function(){return this.resultLimit=+$("#limit").val()||100,this.updateResults()},s.prototype.setOffset=function(){var t,e,s;return s=+$("#page").val()||1,t=(s-1)*this.resultLimit,e=Math.floor(this.results.length/this.resultLimit),this.resultOffset=Math.limit(0,t,e*this.resultLimit),this.updateResults()},s.prototype.updateResults=function(e){var s,i;return 0===(null!=(i=this.results)?i.length:void 0)?void this.$el.find("#results_header").html(this.text.noResults):(s=new ResultPreviews,s.fetch({viewOptions:{key:"result-"+this.assessment.id}}).then(function(i){return function(){var n,l,o,a,r,u,c;return console.log("testing"),console.log(i),console.log(arguments),n=s.labelngth,r=100,l=Math.floor(i.resultOffset/i.resultLimit)+1,i.results.length>r&&(i.$el.find("#controls").removeClass("confirmation"),i.$el.find("#page").val(l),i.$el.find("#limit").val(i.resultLimit)),u=i.resultOffset+1,o=Math.min(i.resultOffset+i.resultLimit,i.results.length),c=i.results.length,i.$el.find("#result_position").html(t("ResultsView.label.pagination",{start:u,end:o,total:c})),a="",console.log(s),s.models.forEach(function(t){var e,s,n,l,o,r;return console.log("doing thisone"),n=t.getString("participantId","No ID"),e=t.get("endTime"),null!=e?(l=moment(e).format("YYYY-MMM-DD HH:mm"),s=moment(e).fromNow()):(o=t.get("startTime"),l="<b>"+i.text.started+"</b> "+moment(o).format("YYYY-MMM-DD HH:mm"),s=moment(o).fromNow()),r=l+" ("+s+")",a+="<div> "+n+" - "+r+" <button data-result-id='"+t.id+"' class='details command'>"+i.text.details+"</button> <div id='details_"+t.id+"'></div> </div>"}),console.log("got here"),console.log(a),i.$el.find("#results_container").html(a),i.$el.find(e).focus()}}(this)))},s.prototype.afterRender=function(){var t,e,s,i,n;for(s=this.subViews,i=[],t=0,e=s.length;e>t;t++)n=s[t],i.push("function"==typeof n.afterRender?n.afterRender():void 0);return i},s.prototype.clearSubViews=function(){var t,e,s,i;for(s=this.subViews,t=0,e=s.length;e>t;t++)i=s[t],i.close();return this.subViews=[]},s}(Backbone.View);