var GridRunView,bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function i(){this.constructor=t}for(var s in e)hasProp.call(e,s)&&(t[s]=e[s]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;GridRunView=function(e){function i(){return this.updateMode=bind(this.updateMode,this),this.updateCountdown=bind(this.updateCountdown,this),this.removeUndo=bind(this.removeUndo,this),this.lastHandler=bind(this.lastHandler,this),this.intermediateItemHandler=bind(this.intermediateItemHandler,this),this.markHandler=bind(this.markHandler,this),this.gridClick=bind(this.gridClick,this),i.__super__.constructor.apply(this,arguments)}return extend(i,e),i.prototype.className="grid_prototype",i.prototype.events=Modernizr.touch?{"click .grid_element":"gridClick","click .end_of_grid_line":"endOfGridLineClick","click .start_time":"startTimer","click .stop_time":"stopTimer","click .restart":"restartTimer"}:{"click .end_of_grid_line":"endOfGridLineClick","click .grid_element":"gridClick","click .start_time":"startTimer","click .stop_time":"stopTimer","click .restart":"restartTimer"},i.prototype.restartTimer=function(){return this.timeRunning&&this.stopTimer({simpleStop:!0}),this.resetVariables(),this.$el.find(".element_wrong").removeClass("element_wrong")},i.prototype.gridClick=function(t){var e,i;return t.preventDefault(),"function"==typeof(e=this.modeHandlers)[i=this.mode]?e[i](t):void 0},i.prototype.markHandler=function(t){var e,i,s,a,n,r,o;return e=$(t.target),s=e.attr("data-index"),a=parseInt(s)>parseInt(this.lastAttempted),n=0!==parseInt(this.lastAttempted),i=this.dataEntry===!1&&(null!=(r=this.parent)&&null!=(o=r.parent)?o.enableCorrections:void 0)===!1,i&&n&&a?void 0:(this.markElement(s),0!==this.autostop?this.checkAutostop():void 0)},i.prototype.intermediateItemHandler=function(t){var e,i;return this.timeIntermediateCaptured=this.getTime()-this.startTime,e=$(t.target),i=e.attr("data-index"),this.itemAtTime=i,e.addClass("element_minute"),this.updateMode("mark")},i.prototype.checkAutostop=function(){var t,e,i,s;if(this.timeRunning){for(t=0,e=i=0,s=this.autostop-1;(s>=0?s>=i:i>=s)&&"correct"!==this.gridOutput[e];e=s>=0?++i:--i)t++;if(this.autostopped===!1&&t===this.autostop&&this.autostopTest(),this.autostopped===!0&&t<this.autostop&&this.undoable===!0)return this.unAutostopTest()}},i.prototype.markElement=function(t,e,i){var s,a,n,r,o,m,d,l;if(null==e&&(e=null),a=this.dataEntry===!1&&null!=(null!=(o=this.parent)&&null!=(m=o.parent)?m.enableCorrections:void 0)&&(null!=(d=this.parent)&&null!=(l=d.parent)?l.enableCorrections:void 0)===!1,r=0!==parseInt(this.lastAttempted),n=parseInt(t)>parseInt(this.lastAttempted),!(a&&r&&n||(s=this.$el.find(".grid_element[data-index="+t+"]"),"populate"!==i&&this.markRecord.push(t),this.autostopped))){if(null===e)return this.gridOutput[t-1]="correct"===this.gridOutput[t-1]?"incorrect":"correct",s.toggleClass("element_wrong");if(this.gridOutput[t-1]=e,"incorrect"===e)return s.addClass("element_wrong");if("correct"===e)return s.removeClass("element_wrong")}},i.prototype.endOfGridLineClick=function(t){var e,i,s,a,n,r,o,m,d;if(t.preventDefault(),"mark"===this.mode){if(e=$(t.target),e.hasClass("element_wrong"))for(e.removeClass("element_wrong"),s=e.attr("data-index"),i=a=r=s,o=s-(this.columns-1);o>=r?o>=a:a>=o;i=o>=r?++a:--a)this.markElement(i,"correct");else if(!e.hasClass("element_wrong")&&!this.autostopped)for(e.addClass("element_wrong"),s=e.attr("data-index"),i=n=m=s,d=s-(this.columns-1);d>=m?d>=n:n>=d;i=d>=m?++n:--n)this.markElement(i,"incorrect");if(0!==this.autostop)return this.checkAutostop()}},i.prototype.lastHandler=function(t,e){var i;return null!=e?i=this.$el.find(".grid_element[data-index="+e+"]"):(i=$(t.target),e=i.attr("data-index")),e-1>=this.gridOutput.lastIndexOf("incorrect")?(this.$el.find(".element_last").removeClass("element_last"),i.addClass("element_last"),this.lastAttempted=e):void 0},i.prototype.startTimer=function(){return this.timerStopped===!1&&this.timeRunning===!1?(this.interval=setInterval(this.updateCountdown,1e3),this.startTime=this.getTime(),this.timeRunning=!0,this.updateMode("mark"),this.enableGrid(),this.updateCountdown()):void 0},i.prototype.enableGrid=function(){return this.$el.find("table.disabled, div.disabled").removeClass("disabled")},i.prototype.stopTimer=function(t,e){return null==e&&(e=!1),this.timeRunning===!0?((null!=t?t.target:void 0)&&this.lastHandler(null,this.items.length),clearInterval(this.interval),this.stopTime=this.getTime(),this.timeRunning=!1,this.timerStopped=!0,this.updateCountdown()):void 0},i.prototype.autostopTest=function(){return Utils.flash(),clearInterval(this.interval),this.stopTime=this.getTime(),this.autostopped=!0,this.timerStopped=!0,this.timeRunning=!1,this.$el.find(".grid_element").slice(this.autostop-1,this.autostop).addClass("element_last"),this.lastAttempted=this.autostop,this.timeout=setTimeout(this.removeUndo,3e3),Utils.topAlert(this.text.autostop)},i.prototype.removeUndo=function(){return this.undoable=!1,this.updateMode("disabled"),clearTimeout(this.timeout)},i.prototype.unAutostopTest=function(){return this.interval=setInterval(this.updateCountdown,1e3),this.updateCountdown(),this.autostopped=!1,this.lastAttempted=0,this.$el.find(".grid_element").slice(this.autostop-1,this.autostop).removeClass("element_last"),this.timeRunning=!0,this.updateMode("mark"),Utils.topAlert(t("GridRunView.message.autostop_cancel"))},i.prototype.updateCountdown=function(){return this.timeElapsed=Math.min(this.getTime()-this.startTime,this.timer),this.timeRemaining=this.timer-this.timeElapsed,this.$el.find(".timer").html(this.timeRemaining),this.timeRunning===!0&&this.captureLastAttempted&&this.timeRemaining<=0&&(this.stopTimer({simpleStop:!0}),Utils.background("red"),_.delay(function(t){return function(){return alert(t.text.touchLastItem),Utils.background("")}}(this),1e3),this.updateMode(event,"last")),this.captureItemAtTime&&!this.gotIntermediate&&!this.minuteMessage&&this.timeElapsed>=this.captureAfterSeconds?(Utils.flash("yellow"),Utils.midAlert(t("please select the item the child is currently attempting")),this.minuteMessage=!0,this.mode="minuteItem"):void 0},i.prototype.updateMode=function(t){return null==t&&(t=null),null===t&&0===this.timeElapsed&&!this.dataEntry||"disabled"===t?this.modeButton.setValue(null):null!=t?(this.mode=t,this.modeButton.setValue(this.mode)):this.mode=this.modeButton.getValue()},i.prototype.getTime=function(){return Math.round((new Date).getTime()/1e3)},i.prototype.resetVariables=function(){var t;return this.timer=parseInt(this.model.get("timer"))||0,this.untimed=0===this.timer||this.dataEntry,this.gotMinuteItem=!1,this.minuteMessage=!1,this.itemAtTime=null,this.timeIntermediateCaptured=null,this.markRecord=[],this.timerStopped=!1,this.startTime=0,this.stopTime=0,this.timeElapsed=0,this.timeRemaining=this.timer,this.lastAttempted=0,this.interval=null,this.undoable=!0,this.timeRunning=!1,this.items=_.compact(this.model.get("items")),this.itemMap=[],this.mapItem=[],this.model.has("randomize")&&this.model.get("randomize")?(this.itemMap=this.items.map(function(t,e){return e}),this.items.forEach(function(t,e){var i,s;return i=Math.floor(Math.random()*this.items.length),s=this.itemMap[i],this.itemMap[i]=this.itemMap[e],this.itemMap[e]=s},this),this.itemMap.forEach(function(t,e){return this.mapItem[this.itemMap[e]]=e},this)):this.items.forEach(function(t,e){return this.itemMap[e]=e,this.mapItem[e]=e},this),this.mode=this.captureLastAttempted||this.captureItemAtTime?"disabled":"mark",this.dataEntry&&(this.mode="mark"),this.gridOutput=this.items.map(function(){return"correct"}),this.columns=parseInt(this.model.get("columns"))||3,this.autostop=this.untimed?0:parseInt(this.model.get("autostop"))||0,this.autostopped=!1,this.$el.find(".grid_element").removeClass("element_wrong").removeClass("element_last").addClass("disabled"),this.$el.find("table").addClass("disabled"),this.$el.find(".timer").html(this.timer),this.dataEntry||(t=this.parent.parent.result.getByHash(this.model.get("hash")),t&&(this.captureLastAttempted=t.capture_last_attempted,this.itemAtTime=t.item_at_time,this.timeIntermediateCaptured=t.time_intermediate_captured,this.captureItemAtTime=t.capture_item_at_time,this.autostop=t.auto_stop,this.lastAttempted=t.attempted,this.timeRemaining=t.time_remain,this.markRecord=t.mark_record)),null!=this.modeButton?this.updateMode(this.mode):void 0},i.prototype.i18n=function(){return this.text={autostop:t("GridRunView.message.autostop"),touchLastItem:t("GridRunView.message.touch_last_item"),subtestNotComplete:t("GridRunView.message.subtest_not_complete"),inputMode:t("GridRunView.label.input_mode"),timeRemaining:t("GridRunView.label.time_remaining"),wasAutostopped:t("GridRunView.label.was_autostopped"),mark:t("GridRunView.button.mark"),start:t("GridRunView.button.start"),stop:t("GridRunView.button.stop"),restart:t("GridRunView.button.restart"),lastAttempted:t("GridRunView.button.last_attempted")}},i.prototype.initialize=function(t){var e;return this.i18n(),""!==this.model.get("fontFamily")&&(this.fontStyle='style="font-family: '+this.model.get("fontFamily")+' !important;"'),this.captureAfterSeconds=this.model.has("captureAfterSeconds")?this.model.get("captureAfterSeconds"):0,this.captureItemAtTime=this.model.has("captureItemAtTime")?this.model.get("captureItemAtTime"):!1,this.captureLastAttempted=this.model.has("captureLastAttempted")?this.model.get("captureLastAttempted"):!0,this.endOfLine=this.model.has("endOfLine")?this.model.get("endOfLine"):!0,this.layoutMode=this.model.has("layoutMode")?this.model.get("layoutMode"):"fixed",this.fontSize=this.model.has("fontSize")?this.model.get("fontSize"):"normal",e="small"===this.fontSize?"font_size_small":"",this.rtl=this.model.getBoolean("rtl"),this.rtl&&this.$el.addClass("rtl-grid"),this.totalTime=this.model.get("timer")||0,this.modeHandlers={mark:this.markHandler,last:this.lastHandler,minuteItem:this.intermediateItemHandler,disabled:$.noop},this.dataEntry=t.dataEntry,this.model=t.model,this.parent=t.parent,this.resetVariables(),this.gridElement=_.template("<td><button data-label='{{label}}' data-index='{{i}}' class='grid_element "+e+"' "+(this.fontStyle||"")+">{{label}}</button></td>"),this.variableGridElement=_.template("<button data-label='{{label}}' data-index='{{i}}' class='grid_element "+e+"' "+(this.fontStyle||"")+">{{label}}</button>"),this.endOfGridLine=_.template("fixed"===this.layoutMode?"<td><button data-index='{{i}}' class='end_of_grid_line'>*</button></td>":"")},i.prototype.render=function(){var e,i,s,a,n,r,o,m,d,l,h,p,u,c,g,f,b,v,k,y,A,R,T,I,w;if(r=0,I="<div class='timer_wrapper'><button class='start_time time'>"+this.text.start+"</button><div class='timer'>"+this.timer+"</div></div>",this.untimed||(a="disabled"),this.rtl&&(n="rtl_mode"),d=this.untimed?"":I,m="","fixed"===this.layoutMode){for(m+="<table class='grid "+a+" "+(n||"")+"'>",o=!0;;){if(r>this.items.length)break;for(m+="<tr>",l=p=1,k=this.columns;k>=1?k>=p:p>=k;l=k>=1?++p:--p)r<this.items.length&&(m+=this.gridElement({label:_.escape(this.items[this.itemMap[r]]),i:r+1})),r++;o?(r<this.items.length+1&&this.endOfLine&&(m+="<td></td>"),o=!1):r<this.items.length+1&&this.endOfLine&&(m+=this.endOfGridLine({i:r})),m+="</tr>"}m+="</table>"}else{for(m+="<div class='grid "+a+" "+(n||"")+"'>",y=this.items,l=u=0,g=y.length;g>u;l=++u)h=y[l],m+=this.variableGridElement({label:_.escape(this.items[this.itemMap[l]]),i:l+1});m+="</div>"}if(d+=m,w="<div class='timer_wrapper'><button class='stop_time time'>"+this.text.stop+"</button><div class='timer'>"+this.timer+"</div></div>",T="<div> <button class='restart command'>"+this.text.restart+"</button> <br> </div>",(this.captureLastAttempted||this.captureItemAtTime)&&(null!=(A=this.modeButton)&&A.close(),i={options:[],mode:"single"},i.options.push({label:this.text.mark,value:"mark"}),this.captureItemAtTime&&i.options.push({label:t("item at __seconds__ seconds",{seconds:this.captureAfterSeconds}),value:"minuteItem"}),this.captureLastAttempted&&i.options.push({label:this.text.lastAttempted,value:"last"}),this.modeButton=new ButtonView(i),this.listenTo(this.modeButton,"change click",function(t){return function(){return t.updateMode()}}(this)),b="<div class='grid_mode_wrapper question clearfix'> <label>"+this.text.inputMode+"</label><br> <div class='mode-button'></div> </div>"),s="<table class='class_table'> <tr> <td>"+this.text.wasAutostopped+"</td><td><input type='checkbox' class='data_autostopped'></td> </tr> <tr> <td>"+this.text.timeRemaining+"</td><td><input type='number' class='data_time_remain'></td> </tr> </table>",d+=(this.untimed?"":w)+" "+(this.untimed?"":T)+" "+b+" "+((this.dataEntry?s:void 0)||""),this.$el.html(d),this.modeButton.setElement(this.$el.find(".mode-button")),this.modeButton.render(),this.trigger("rendered"),this.trigger("ready"),!this.dataEntry&&(v=this.parent.parent.result.getByHash(this.model.get("hash")))){for(this.markRecord=v.mark_record,R=this.markRecord,l=c=0,f=R.length;f>c;l=++c)h=R[l],this.markElement(h,null,"populate");return this.itemAtTime=v.item_at_time,e=this.$el.find(".grid_element[data-index="+this.itemAtTime+"]"),e.addClass("element_minute"),this.lastAttempted=v.attempted,e=this.$el.find(".grid_element[data-index="+this.lastAttempted+"]"),e.addClass("element_last")}},i.prototype.isValid=function(){var e,i;return this.timeRunning&&this.stopTimer(),parseInt(this.lastAttempted)===this.items.length&&0===this.timeRemaining?(e=this.items[this.items.length-1],confirm(t("GridRunView.message.last_item_confirm",{item:e}))?(this.updateMode,!0):(this.messages=(null!=(i=this.messages)?i.push:void 0)?this.messages.concat([msg]):[msg],this.updateMode("last"),!1)):this.captureLastAttempted&&0===this.lastAttempted?!1:this.timeRunning===!0?!1:0!==this.timer&&this.timeRemaining===this.timer?!1:!0},i.prototype.showErrors=function(){var t,e,i,s;return t=this.messages||[],this.messages=[],s=0!==this.timer&&this.timeRemaining===this.timer,e=this.captureLastAttempted&&0===this.lastAttempted,i=this.timeRuning===!0,s&&t.push(this.text.subtestNotComplete),e&&!s&&(t.push(this.text.touchLastItem),this.updateMode("last")),i&&t.push(this.text.timeStillRunning),Utils.midAlert(t.join("<br>"),3e3)},i.prototype.getResult=function(){var t,e,i,s,a,n,r,o,m,d;for(e=[],a=[],this.captureLastAttempted||(this.lastAttempted=this.items.length),o=this.items,i=n=0,r=o.length;r>n;i=++n)s=o[i],a[i]=this.mapItem[i]<this.lastAttempted?{itemResult:this.gridOutput[this.mapItem[i]],itemLabel:s}:{itemResult:"missing",itemLabel:this.items[this.mapItem[i]]};return this.captureLastAttempted||(this.lastAttempted=!1),this.dataEntry?(t=this.$el.find(".data_autostopped").is(":checked"),d=parseInt(this.$el.find(".data_time_remain").val())):(t=this.autostopped,d=this.timeRemaining),m={capture_last_attempted:this.captureLastAttempted,item_at_time:this.itemAtTime,time_intermediate_captured:this.timeIntermediateCaptured,capture_item_at_time:this.captureItemAtTime,auto_stop:t,attempted:this.lastAttempted,items:a,time_remain:d,mark_record:this.markRecord,variable_name:this.model.get("variableName")}},i.prototype.getSkipped=function(){var t,e,i,s,a,n,r;for(i=[],n=this.items,t=s=0,a=n.length;a>s;t=++s)e=n[t],i[t]={itemResult:"skipped",itemLabel:e};return r={capture_last_attempted:"skipped",item_at_time:"skipped",time_intermediate_captured:"skipped",capture_item_at_time:"skipped",auto_stop:"skipped",attempted:"skipped",items:i,time_remain:"skipped",mark_record:"skipped",variable_name:this.model.get("variableName")}},i.prototype.onClose=function(){return clearInterval(this.interval)},i}(Backbone.View);