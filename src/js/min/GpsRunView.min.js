var GpsRunView,bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function i(){this.constructor=t}for(var n in e)hasProp.call(e,n)&&(t[n]=e[n]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;GpsRunView=function(e){function i(){return this.poll=bind(this.poll,this),i.__super__.constructor.apply(this,arguments)}return extend(i,e),i.prototype.className="GpsRunView",i.prototype.events={"click .clear":"clear"},i.prototype.clear=function(){return this.position=null,this.updateDisplay()},i.prototype.initialize=function(t){return this.i18n(),this.model=t.model,this.parent=t.parent,this.dataEntry=t.dataEntry,this.position=null,this.retryCount=0},i.prototype.i18n=function(){return this.text={clear:t("GpsRunView.button.clear"),good:t("GpsRunView.label.good"),ok:t("GpsRunView.label.ok"),poor:t("GpsRunView.label.poor"),latitude:t("GpsRunView.label.latitude"),longitude:t("GpsRunView.label.longitude"),accuracy:t("GpsRunView.label.accuracy"),meters:t("GpsRunView.label.meters"),savedReading:t("GpsRunView.label.saved_reading"),currentReading:t("GpsRunView.label.current_reading"),bestReading:t("GpsRunView.label.best_reading"),gpsStatus:t("GpsRunView.label.gps_status"),gpsOk:t("GpsRunView.message.gps_ok"),retrying:t("GpsRunView.message.retrying"),searching:t("GpsRunView.message.searching"),notSupported:_(t("GpsRunView.message.not_supported")).escape()}},i.prototype.poll=function(){return navigator.geolocation.getCurrentPosition(function(t){return function(e){return t.updateDisplay(e),t.updatePosition(e),t.updateStatus(t.text.gpsOk),t.retryCount=0,t.stopPolling?void 0:setTimeout(t.poll(),5e3)}}(this),function(t){return function(e){return t.updateStatus(e.message),t.stopPolling||setTimeout(t.poll(),5e3),t.retryCount++}}(this),{maximumAge:1e4,timeout:3e4,enableHighAccuracy:!0})},i.prototype.easify=function(t){var e,i,n,o,s,r,l;return{lat:null!=(null!=t&&null!=(e=t.coords)?e.latitude:void 0)?t.coords.latitude:"...","long":null!=(null!=t&&null!=(i=t.coords)?i.longitude:void 0)?t.coords.longitude:"...",alt:null!=(null!=t&&null!=(n=t.coords)?n.altitude:void 0)?t.coords.altitude:"...",acc:null!=(null!=t&&null!=(o=t.coords)?o.accuracy:void 0)?t.coords.accuracy:"...",altAcc:null!=(null!=t&&null!=(s=t.coords)?s.altitudeAccuracy:void 0)?t.coords.altitudeAccuracy:"...",heading:null!=(null!=t&&null!=(r=t.coords)?r.heading:void 0)?t.coords.heading:"...",speed:null!=(null!=t&&null!=(l=t.coords)?l.speed:void 0)?t.coords.speed:"...",timestamp:null!=(null!=t?t.timestamp:void 0)?t.timestamp:"..."}},i.prototype.updatePosition=function(t){var e;return t=this.easify(t),null==this.position&&(this.position=t),null!=(null!=t?t.acc:void 0)&&null!=(null!=(e=this.position)?e.acc:void 0)&&t.acc<=this.position.acc?this.position=t:void 0},i.prototype.updateDisplay=function(t){var e,i,n,o,s,r,l,a,u,p,d,c;for(t=this.easify(t),d=[{el:this.$el.find(".gps_current"),data:t},{el:this.$el.find(".gps_best"),data:this.position}],c=[],s=r=0,a=d.length;a>r;s=++r)p=d[s],i=p.data,n=p.el,l=(null!=i?i.lat:void 0)?parseFloat(i.lat).toFixed(4):"...",u=(null!=i?i.long:void 0)?parseFloat(i.long).toFixed(4):"...",e=(null!=i?i.acc:void 0)?parseInt(i.acc)+(" "+this.text.meters):"...",e+=parseInt(null!=i?i.acc:void 0)<50?"("+this.text.good+")":parseInt(null!=i?i.acc:void 0)>100?"("+this.text.poor+")":"("+this.text.ok+")",o="<table> <tr><td>"+this.text.latitude+"</td> <td>"+l+"</td></tr> <tr><td>"+this.text.longitude+"</td><td>"+u+"</td></tr> <tr><td>"+this.text.accuracy+"</td> <td>"+e+"</td></tr> </table>",c.push(n.html(o));return c},i.prototype.updateStatus=function(e){var i,n;return null==e&&(e=""),n=this.retryCount>0?t("GpsRunView.message.attempt",{count:this.retryCount+1}):"",i=this.stopPolling?"":"<br>"+this.text.retrying+" "+n,this.$el.find(".status").html(e+i)},i.prototype.render=function(){var t,e,i,n;return Modernizr.geolocation?(this.dataEntry||(n=this.parent.parent.result.getByHash(this.model.get("hash"))),n?(e=n.lat,i=n.long,t=n.acc,this.$el.html("<section> <h3>"+this.text.savedReading+"</h3> <div class='gps_saved'> <table> <tr><td>"+this.text.latitude+"</td> <td>"+e+"</td></tr> <tr><td>"+this.text.longitude+"</td><td>"+i+"</td></tr> <tr><td>"+this.text.accuracy+"</td> <td>"+t+"</td></tr> </table> </div>")):this.$el.html("<section> <h3>"+this.text.bestReading+"</h3> <div class='gps_best'></div><button class='clear command'>"+this.text.clear+"</button> <h3>"+this.text.currentReading+"</h3> <div class='gps_current'></div> </section> <section> <h2>"+this.text.gpsStatus+"</h2> <div class='status'>"+this.text.searching+"</div> </section>"),this.trigger("rendered"),this.trigger("ready"),this.poll()):(this.$el.html(this.text.notSupported),this.position=this.easify(null),this.trigger("rendered"),this.trigger("ready"))},i.prototype.getResult=function(){var t;return t=this.parent.parent.result.getByHash(this.model.get("hash")),t?t:this.position||{}},i.prototype.getSkipped=function(){return this.position||{}},i.prototype.onClose=function(){return this.stopPolling=!0},i.prototype.isValid=function(){return!0},i.prototype.showErrors=function(){return!0},i}(Backbone.View);