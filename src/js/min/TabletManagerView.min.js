var TabletManagerView,bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function s(){this.constructor=t}for(var n in e)hasProp.call(e,n)&&(t[n]=e[n]);return s.prototype=e.prototype,t.prototype=new s,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;TabletManagerView=function(e){function s(){return this.pushDocs=bind(this.pushDocs,this),this.updatePullResult=bind(this.updatePullResult,this),this.updatePull=bind(this.updatePull,this),this.pullDocs=bind(this.pullDocs,this),this.sync=bind(this.sync,this),s.__super__.constructor.apply(this,arguments)}return extend(s,e),s.prototype.className="KlassesView",s.prototype.i18n=function(){return this.text={detectingTablets:t("TabletManagerView.message.detecting"),syncComplete:t("TabletManagerView.label.sync_complete")}},s.prototype.initialize=function(t){return this.i18n(),this.ipBlock=32,this.totalIps=256,this.tabletOffset=0,this.callbacks=t.callbacks,this.docTypes=t.docTypes},s.prototype.sync=function(){return 0===this.tabletOffset?this.pullDocs():void 0},s.prototype.pullDocs=function(){return 0===this.tabletOffset&&(this.tablets={checked:0,complete:0,successful:0,okCount:0,ips:[],result:0},Utils.midAlert(this.text.detectingTablets)),Utils.working(!0),this.randomIdDoc=hex_sha1(""+Math.random()),Tangerine.$db.saveDoc({_id:this.randomIdDoc},{success:function(t){return function(e){var s,n,i,o,r;for(t.randomDoc=e,r=[],n=s=i=t.tabletOffset,o=t.ipBlock-1+t.tabletOffset;o>=i?o>=s:s>=o;n=o>=i?++s:--s)r.push(function(e){var s,n;return s=Tangerine.settings.subnetIP(e),n=$.ajax({url:Tangerine.settings.urlSubnet(s),dataType:"jsonp",contentType:"application/json;charset=utf-8",timeout:2e4}),n.complete(function(e){return t.tablets.checked++,200===parseInt(e.status)&&(t.tablets.okCount++,t.tablets.ips.push(s)),t.updatePull()})}(n));return r}}(this),error:function(){return Utils.working(!1),Utils.midAlert(this.text.internalError)}})},s.prototype.updatePull=function(){var e,s,n,i,o,r;if(!(this.tablets.checked<this.ipBlock+this.tabletOffset)){if(this.tabletOffset!==this.totalIps-this.ipBlock)return i=Math.round(this.tabletOffset/this.totalIps*100),Utils.midAlert(t("TabletManagerView.message.searching",{percentage:i})),this.tabletOffset+=this.ipBlock,this.pullDocs();if(this.tablets.okCount=Math.max(this.tablets.okCount-1,0),0===this.tablets.okCount)return this.tabletOffset=0,Utils.working(!1),Utils.midAlert(t("TabletManagerView.message.found",{count:this.tablets.okCount})),void Tangerine.$db.removeDoc({_id:this.randomDoc.id,_rev:this.randomDoc.rev});if(!confirm(t("TabletManagerView.message.confirm_pull",{__found__:this.tablets.okCount})))return this.tabletOffset=0,Utils.working(!1),void Tangerine.$db.removeDoc({_id:this.randomDoc.id,_rev:this.randomDoc.rev});for(Utils.midAlert(t("TabletManagerView.message.pull_status",{tabletCount:this.tablets.okCount})),o=this.tablets.ips,r=[],e=0,n=o.length;n>e;e++)s=o[e],r.push(function(t){return function(e){var s;return s=$.ajax({url:Tangerine.settings.urlSubnet(e)+"/"+t.randomIdDoc,dataType:"jsonp",timeout:1e4,contentType:"application/json;charset=utf-8"}),s.success(function(){return t.selfSubnetIp=e}),s.complete(function(s){return function(s){var n;if(200!==parseInt(s.status))return n=$.ajax({url:Tangerine.settings.urlSubnet(e)+"/_design/tangerine/_view/byCollection",dataType:"jsonp",contentType:"application/json;charset=utf-8",data:{include_docs:!1,keys:JSON.stringify(t.docTypes)}}),n.success(function(s){var n,i;return i=function(){var t,e,i,o;for(i=s.rows,o=[],t=0,e=i.length;e>t;t++)n=i[t],o.push(n.id);return o}(),$.couch.replicate(Tangerine.settings.urlSubnet(e),Tangerine.settings.urlDB("local"),{success:function(){return t.tablets.complete++,t.tablets.successful++,t.updatePullResult()},error:function(){return t.tablets.complete++,t.updatePullResult()}},{doc_ids:i})})}(s)})}}(this)(s));return r}},s.prototype.updatePullResult=function(){var e;return this.tablets.complete===this.tablets.okCount?(Utils.working(!1),Utils.midAlert(t("TabletManagerView.message.pull_complete",{successful:this.tablets.successful,total:this.tablets.okCount})),Tangerine.$db.removeDoc({_id:this.randomDoc.id,_rev:this.randomDoc.rev}),"function"==typeof(e=this.callbacks).completePull?e.completePull():void 0):void 0},s.prototype.pushDocs=function(){return _.isObject(this.push)?this.push.complete===this.push.ips.length?(Utils.working(!1),Utils.sticky("<b>"+this.text.syncComplete+"</b><br>"+t("TabletManagerView.message.successful_count",{successful:this.push.successful,total:this.push.complete}))):(Utils.midAlert(t("TabletManagerView.message.syncing",{done:this.push.complete+1,total:this.push.ips.length})),$.couch.replicate(Tangerine.settings.urlDB("local"),Tangerine.settings.urlSubnet(this.push.ips[this.push.current]),{success:function(t){return function(){return t.push.complete++,t.push.successful++,t.pushDocs()}}(this),error:function(t){return function(){return t.push.complete++,t.pushDocs()}}(this)},{doc_ids:this.push.docIds})):(Utils.working(!0),Tangerine.$db.view(Tangerine.design_doc+"/byCollection",{keys:this.docTypes,success:function(t){return function(e){var s;return s=_.pluck(e.rows,"id"),t.push={ips:_.without(t.tablets.ips,t.selfSubnetIp),docIds:s,current:0,complete:0,successful:0},t.pushDocs()}}(this)}))},s}(Backbone.View);