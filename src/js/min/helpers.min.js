var ResultOfGrid,ResultOfMultiple,ResultOfPrevious,ResultOfQuestion,Robbert,Tangerine,TangerineTree,Utils,slice=[].slice;ResultOfQuestion=function(e){var t,n;if(n=null,t=vm.currentView.orderMap[vm.currentView.index],vm.currentView.subtestViews[t].prototypeView.questionViews.forEach(function(t){return t.model.get("name")===e?n=t:void 0}),null===n)throw new ReferenceError("ResultOfQuestion could not find variable "+e);return n.answer?n.answer:null},ResultOfMultiple=function(e){var t,n,r,o,i,u;if(i=null,t=vm.currentView.orderMap[vm.currentView.index],vm.currentView.subtestViews[t].prototypeView.questionViews.forEach(function(t){return t.model.get("name")===e?i=t:void 0}),null===i)throw new ReferenceError("ResultOfQuestion could not find variable "+e);o=[],r=i.answer;for(n in r)u=r[n],"checked"===u&&o.push(n);return o},ResultOfPrevious=function(e){return vm.currentView.result.getVariable(e)},ResultOfGrid=function(e){return vm.currentView.result.getItemResultCountByVariableName(e,"correct")},Tangerine=null!=Tangerine?Tangerine:{},Tangerine.onBackButton=function(){return"assessment run"===Tangerine.activity?confirm(t("NavigationView.message.incomplete_main_screen"))?(Tangerine.activity="",window.history.back()):!1:window.history.back()},Backbone.View.prototype.close=function(){return this.remove(),this.unbind(),"function"==typeof this.onClose?this.onClose():void 0},Backbone.Collection.prototype.indexBy=function(e){var t;return t={},this.models.forEach(function(n){var r;return n.has(e)?(r=n.get(e),null==t[r]&&(t[r]=[]),t[r].push(n)):void 0}),t},Backbone.Collection.prototype.indexArrayBy=function(e){var t;return t=[],this.models.forEach(function(n){var r;return n.has(e)?(r=n.get(e),null==t[r]&&(t[r]=[]),t[r].push(n)):void 0}),t},Backbone.Collection.prototype.parse=function(e){return _.pluck(e.rows,"doc")},Backbone.Model.prototype._save=Backbone.Model.prototype.save,Backbone.Model.prototype.save=function(){return"function"==typeof this.beforeSave&&this.beforeSave(),this.stamp(),this._save.apply(this,arguments)},Backbone.Model.prototype.stamp=function(){var e;return this.set({editedBy:(null!=Tangerine&&null!=(e=Tangerine.user)?e.name():void 0)||"unknown",updated:(new Date).toString(),fromInstanceId:Tangerine.settings.getString("instanceId"),collection:this.url},{silent:!0})},Backbone.Model.prototype.getNumber=function(e,t){return null==t&&(t=0),this.has(e)?parseInt(this.get(e)):t},Backbone.Model.prototype.getArray=function(e,t){return null==t&&(t=[]),this.has(e)?this.get(e):t},Backbone.Model.prototype.getString=function(e,t){return null==t&&(t=""),this.has(e)?this.get(e):t},Backbone.Model.prototype.getEscapedString=function(e,t){return null==t&&(t=""),this.has(e)?this.escape(e):t},Backbone.Model.prototype.getBoolean=function(e){return this.has(e)?this.get(e)===!0||"true"===this.get(e):void 0},function(e){return e.fn.scrollTo=function(t,n){var r,o;null==t&&(t=250);try{e("html, body").animate({scrollTop:e(this).offset().top+"px"},t,null,n)}catch(o){r=o,console.log("error",r),console.log("Scroll error with 'this'",this)}return this},e.fn.topCenter=function(){return this.css("position","absolute"),this.css("top",e(window).scrollTop()+"px"),this.css("left",(e(window).width()-this.outerWidth())/2+e(window).scrollLeft()+"px")},e.fn.middleCenter=function(){return this.css("position","absolute"),this.css("top",(e(window).height()-this.outerHeight())/2+e(window).scrollTop()+"px"),this.css("left",(e(window).width()-this.outerWidth())/2+e(window).scrollLeft()+"px")}}(jQuery),String.prototype.safetyDance=function(){return this.replace(/\s/g,"_").replace(/[^a-zA-Z0-9_]/g,"")},String.prototype.databaseSafetyDance=function(){return this.replace(/\s/g,"_").toLowerCase().replace(/[^a-z0-9_-]/g,"")},String.prototype.count=function(e){var t;return(null!=(t=this.match(new RegExp(e,"g")))?t.length:void 0)||0},Math.ave=function(){var e,t,n,r;for(n=0,e=0,t=arguments.length;t>e;e++)r=arguments[e],n+=r;return n/=arguments.length},Math.isInt=function(){return"number"==typeof n&&parseFloat(n)===parseInt(n,10)&&!isNaN(n)},Math.decimals=function(e,t){var n;return n=Math.pow(10,t),e*=n,e=0>e+e?-.5:0,e/=n},Math.commas=function(e){return parseInt(e).toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},Math.limit=function(e,t,n){return Math.max(e,Math.min(t,n))},_.isEmptyString=function(e){return null===e?!0:_.isString(e)||_.isNumber(e)?(_.isNumber(e)&&(e=String(e)),""===e.replace(/\s*/,"")?!0:!1):!1},_.indexBy=function(e,t){var n,r,o,i,u;for(u={},n=0,o=t.length;o>n;n++)i=t[n],null!=i[e]&&(r=i[e],null==u[r]&&(u[r]=[]),u[r].push(i));return u},Utils=function(){function e(){}return e.execute=function(e){var t;return(t=function(){var n;return n=e.shift(),"function"==typeof n?n(t):void 0})()},e.universalUpload=function(){var t;return t=new Results,t.fetch({success:function(){var n,r,o;return n=t.pluck("_id"),r=Tangerine.settings.get("groupHost")+"/_session",o={success:function(){return PouchDB.replicate("tangerine",Tangerine.settings.urlDB("group"),{doc_ids:n}).on("complete",function(){return e.sticky("Results synced to cloud successfully.")}).on("error",function(){return e.sticky("Upload error<br>"+code+" "+message)})}},e.checkSession(r,o)}})},e.checkSession=function(e,t){return t=t||{},$.ajax({type:"GET",url:e,async:!0,data:"",beforeSend:function(e){return e.setRequestHeader("Accept","application/json")},complete:function(e){var n;return n=$.parseJSON(e.responseText),200!==e.status?t.error?(console.log("Error:"+e.status+" resp.error: "+n.error),t.error(e.status,n.error,n.reason)):alert("An error occurred getting session info: "+n.reason):(console.log("Logged in."),t.success?t.success(n):void 0)}})},e.restartTangerine=function(t,n){return e.midAlert(""+(t||"Restarting Tangerine")),_.delay(function(){return document.location.reload(),"function"==typeof n?n():void 0},2e3)},e.onUpdateSuccess=function(t){return e.documentCounter++,e.documentCounter===t?(e.restartTangerine("Update successful",function(){return Tangerine.router.navigate("",!1),"server"!==Tangerine.settings.get("context")?e.askToLogout():void 0}),e.documentCounter=null):void 0},e.log=function(e,t){var n;return n=e.constructor.toString().match(/function\s*(\w+)/)[1],console.log(n+": "+t)},e.data=function(){var e,t,n,r;if(t=1<=arguments.length?slice.call(arguments,0):[],1===t.length){if(e=t[0],_.isString(e))return Tangerine.tempData[e];if(_.isObject(e))return Tangerine.tempData=$.extend(Tangerine.tempData,e);if(null===e)return Tangerine.tempData={}}else{if(2===t.length)return n=t[0],r=t[1],Tangerine.tempData[n]=r,Tangerine.tempData;if(0===t.length)return Tangerine.tempData}},e.working=function(t){return t?null==Tangerine.loadingTimer?Tangerine.loadingTimer=setTimeout(e.showLoadingIndicator,3e3):void 0:(null!=Tangerine.loadingTimer&&(clearTimeout(Tangerine.loadingTimer),Tangerine.loadingTimer=null),$(".loading_bar").remove())},e.showLoadingIndicator=function(){return $("<div class='loading_bar'><img class='loading' src='images/loading.gif'></div>").appendTo("body").middleCenter()},e.confirm=function(e,t){var n;return null==(null!=(n=navigator.notification)?n.confirm:void 0)?window.confirm(e)?(t.callback(!0),!0):(t.callback(!1),!1):(navigator.notification.confirm(e,function(e){return t.callback(1===e?!0:2===e?!1:e)},t.title,t.action+",Cancel"),0)},e.getValues=function(e){var t;return t={},$(e).find("input[type=text], input[type=password], textarea").each(function(e,n){return t[n.id]=n.value}),t},e.cleanURL=function(e){return-1!==("function"==typeof e.indexOf?e.indexOf("%"):void 0)?e=decodeURIComponent(e):e},e.topAlert=function(t,n){return null==n&&(n=2e3),e.alert("top",t,n)},e.midAlert=function(t,n){return null==n&&(n=2e3),e.alert("middle",t,n)},e.alert=function(t,n,r){var o,i,u;switch(null==r&&(r=2e3),t){case"top":u=".top_alert",i=function(e){return e.topCenter()};break;case"middle":u=".mid_alert",i=function(e){return e.middleCenter()}}return null!=e[t+"AlertTimer"]?(clearTimeout(e[t+"AlertTimer"]),o=$(u),o.html(o.html()+"<br>"+n)):o=$("<div class='"+u.substring(1)+" disposable_alert'>"+n+"</div>").appendTo("#content"),i(o),function(n,r,o){var i;return i=1500*((""+n.html()).match(/<br>/g)||[]).length,e[t+"AlertTimer"]=setTimeout(function(){return e[t+"AlertTimer"]=null,n.fadeOut(250,function(){return $(this).remove()})},Math.max(i,o))}(o,u,r)},e.sticky=function(e,t,n,r){var o;return null==t&&(t="Close"),null==r&&(r="middle"),o=$("<div class='sticky_alert'>"+e+"<br><button class='command parent_remove'>"+t+"</button></div>").appendTo("#content"),"middle"===r?o.middleCenter():"top"===r&&o.topCenter(),o.on("keyup",function(e){return 27===e.which?$(this).remove():void 0}).find("button").click(n)},e.topSticky=function(t,n,r){return null==n&&(n="Close"),e.sticky(t,n,r,"top")},e.modal=function(e){return e===!1?void $("#modal_back, #modal").remove():($("body").prepend("<div id='modal_back'></div>"),$("<div id='modal'>"+e+"</div>").appendTo("#content").middleCenter().on("keyup",function(e){return 27===e.which?$("#modal_back, #modal").remove():void 0}))},e.passwordPrompt=function(t){var n,r,o;return o="<div id='pass_form' title='User verification'> <label for='password'>Please re-enter your password</label> <input id='pass_val' type='password' name='password' id='password' value=''> <button class='command' data-verify='true'>Verify</button> <button class='command'>Cancel</button> </div>",e.modal(o),r=$("#pass_val"),n=$("#pass_valform button"),r.on("keyup",function(o){return 13!==o.which?!0:(n.off("click"),r.off("change"),t(r.val()),e.modal(!1))}),n.on("click",function(o){return n.off("click"),r.off("change"),"true"===$(o.target).attr("data-verify")&&t(r.val()),e.modal(!1)})},e.guid=function(){return this.S4()+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+this.S4()+this.S4()},e.S4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},e.humanGUID=function(){return this.randomLetters(4)+"-"+this.randomLetters(4)+"-"+this.randomLetters(4)},e.safeLetters="abcdefghijlmnopqrstuvwxyz".split(""),e.randomLetters=function(t){var n;for(n="";t--;)n+=e.safeLetters[Math.floor(Math.random()*e.safeLetters.length)];return n},e.flash=function(t,n){return null==t&&(t="red"),null==n&&(n=null),null==n?(e.background(t),setTimeout(function(){return e.background("")},1e3)):void 0},e.background=function(e){return $("#content_wrapper").css(null!=e?{backgroundColor:e}:"backgroundColor")},e.$_GET=function(){var e,t;return t={},e=window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(e,n,r){return r=~r.indexOf("#")?r.split("#")[0]:r,t[n]=r.split("#")[0]}),t},e.resizeScrollPane=function(){return $(".scroll_pane").height($(window).height()-($("#navigation").height()+$("#footer").height()+100))},e.askToLogout=function(){return confirm("Would you like to logout now?")?Tangerine.user.logout():void 0},e.updateFromServer=function(e){var t,n,r,o;return t=e.id.substr(-5,5),this.trigger("status","import lookup"),n=Tangerine.settings.urlDB("group"),o=Tangerine.conf.db_name,r=Tangerine.settings.urlView("group","byDKey"),$.ajax({url:r,type:"POST",dataType:"json",data:JSON.stringify({keys:t}),error:function(t,n){return e.trigger("status","import error",t+" "+n)},success:function(r){var i;return i=r.rows.reduce(function(e,t){return e[t.id]=!0},{}),Tangerine.db.query(Tangerine.conf.design_doc+"/byDKey",{key:t}).then(function(t){return null==t.rows&&console.warn(t),i=r.rows.reduce(function(e,t){return e[t.id]=!0},i),i=Object.keys(i),$.couch.replicate(n,o,{success:function(t){return e.trigger("status","import success",t)},error:function(t,n){return e.trigger("status","import error",t+" "+n)}},{doc_ids:i})})}})},e}(),Robbert=function(){function e(){}return e.request=function(e){var t,n;return n=e.success,t=e.error,delete e.success,delete e.error,$.ajax({type:"POST",crossDomain:!0,url:Tangerine.config.get("robbert"),dataType:"json",data:e,success:function(){return function(e){return n(e)}}(this),error:function(){return function(e){return t(e)}}(this)})},e}(),TangerineTree=function(){function e(){}return e.make=function(e){var t,n;return Utils.working(!0),n=e.success,t=e.error,delete e.success,delete e.error,e.user=Tangerine.user.name(),$.ajax({type:"POST",crossDomain:!0,url:Tangerine.config.get("tree")+("make/"+Tangerine.settings.get("groupName")),dataType:"json",data:e,success:function(){return function(e){return n(e)}}(this),error:function(){return function(e){return t(e,JSON.parse(e.responseText))}}(this),complete:function(){return Utils.working(!1)}})},e}(),$(function(){return $("#content").on("click",".clear_message",null,function(e){return $(e.target).parent().fadeOut(250,function(){return $(this).empty().show()})}),$("#content").on("click",".parent_remove",null,function(e){return $(e.target).parent().fadeOut(250,function(){return $(this).remove()})}),$("#content").on("click",".alert_button",function(){var e;return e=$(this).attr("data-alert")?$(this).attr("data-alert"):$(this).val(),Utils.disposableAlert(e)}),$("#content").on("click",".disposable_alert",function(){return $(this).stop().fadeOut(100,function(){return $(this).remove()})})});