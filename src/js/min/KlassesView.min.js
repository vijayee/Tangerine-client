var KlassesView,bind=function(t,e){return function(){return t.apply(e,arguments)}},extend=function(t,e){function s(){this.constructor=t}for(var n in e)hasProp.call(e,n)&&(t[n]=e[n]);return s.prototype=e.prototype,t.prototype=new s,t.__super__=e.prototype,t},hasProp={}.hasOwnProperty;KlassesView=function(e){function s(){return this.render=bind(this.render,this),this.onSubviewRendered=bind(this.onSubviewRendered,this),this.updatePullResult=bind(this.updatePullResult,this),this.updatePull=bind(this.updatePull,this),this.updateUploader=bind(this.updateUploader,this),s.__super__.constructor.apply(this,arguments)}return extend(s,e),s.prototype.className="KlassesView",s.prototype.events={"click .klass_add":"toggleAddForm","click .klass_cancel":"toggleAddForm","click .klass_save":"saveNewKlass","click .klass_curricula":"gotoCurricula","click .goto_class":"gotoKlass","click .pull_data":"pullData","click .verify":"ghostLogin","click .upload_data":"uploadData"},s.prototype.initialize=function(t){var e;return this.ipBlock=32,this.totalIps=256,this.tabletOffset=0,this.views=[],this.klasses=t.klasses,this.curricula=t.curricula,this.teachers=t.teachers,this.klasses.on("add remove change",this.render),Tangerine.user.isAdmin()?(this.timer=setTimeout(function(t){return function(){return t.updateUploader(!1)}}(this),2e4),e=$.ajax({url:Tangerine.settings.urlView("group","byDKey"),dataType:"jsonp",data:{keys:["testtest"]},timeout:5e3,success:function(t){return function(){return clearTimeout(t.timer),t.updateUploader(!0)}}(this)})):void 0},s.prototype.ghostLogin=function(){return Tangerine.user.ghostLogin(Tangerine.settings.upUser,Tangerine.settings.upPass)},s.prototype.uploadData=function(){return $.ajax({url:"/"+Tangerine.db_name+"/_design/tangerine/_view/byCollection?include_docs=false",type:"POST",dataType:"json",contentType:"application/json;charset=utf-8",data:JSON.stringify({include_docs:!1,keys:["result","klass","student","teacher","logs","user"]}),success:function(){return function(t){var e;return e=_.pluck(t.rows,"id"),$.couch.replicate(Tangerine.settings.urlDB("local"),Tangerine.settings.urlDB("group"),{success:function(){return Utils.midAlert("Sync successful")},error:function(t,e){return Utils.midAlert("Sync error<br>"+t+" "+e)}},{doc_ids:e})}}(this)})},s.prototype.updateUploader=function(t){var e;return e=t===!0?"<button class='upload_data command'>Upload</button>":t===!1?"<div class='menu_box'><small>No connection</small><br><button class='command verify'>Verify connection</button></div>":"<button class='command' disabled='disabled'>Verifying connection...</button>",this.$el.find(".uploader").html(e)},s.prototype.pullData=function(){return 0===this.tabletOffset&&(this.tablets={checked:0,complete:0,successful:0,okCount:0,ips:[],result:0},Utils.midAlert("Please wait, detecting tablets.")),Utils.working(!0),this.randomIdDoc=hex_sha1(""+Math.random()),Tangerine.$db.saveDoc({_id:this.randomIdDoc},{success:function(t){return function(e){var s,n,r,i,a;for(t.randomDoc=e,a=[],n=s=r=t.tabletOffset,i=t.ipBlock-1+t.tabletOffset;i>=r?i>=s:s>=i;n=i>=r?++s:--s)a.push(function(e){var s,n;return s=Tangerine.settings.subnetIP(e),n=$.ajax({url:Tangerine.settings.urlSubnet(s),dataType:"jsonp",contentType:"application/json;charset=utf-8",timeout:1e4}),n.complete(function(e){return t.tablets.checked++,200===parseInt(e.status)&&(t.tablets.okCount++,t.tablets.ips.push(s)),t.updatePull()})}(n));return a}}(this),error:function(){return Utils.working(!1),Utils.midAlert("Internal database error")}})},s.prototype.updatePull=function(){var t,e,s,n,r;if(!(this.tablets.checked<this.ipBlock+this.tabletOffset)){if(this.tabletOffset!==this.totalIps-this.ipBlock)return this.tabletOffset+=this.ipBlock,this.pullData();if(this.tablets.okCount=Math.max(this.tablets.okCount-1,0),0===this.tablets.okCount)return this.tabletOffset=0,Utils.working(!1),Utils.midAlert(this.tablets.okCount+" tablets found."),void Tangerine.$db.removeDoc({_id:this.randomDoc.id,_rev:this.randomDoc.rev});if(!confirm(this.tablets.okCount+" tablets found.\n\nStart data pull?"))return this.tabletOffset=0,Utils.working(!1),void Tangerine.$db.removeDoc({_id:this.randomDoc.id,_rev:this.randomDoc.rev});for(Utils.midAlert("Pulling from "+this.tablets.okCount+" tablets."),n=this.tablets.ips,r=[],t=0,s=n.length;s>t;t++)e=n[t],r.push(function(t){return function(e){var s;return s=$.ajax({url:Tangerine.settings.urlSubnet(e)+"/"+t.randomIdDoc,dataType:"jsonp",timeout:1e4,contentType:"application/json;charset=utf-8"}),s.success(function(){}),s.complete(function(s){return function(s){var n;if(200!==parseInt(s.status))return n=$.ajax({url:Tangerine.settings.urlSubnet(e)+"/_design/tangerine/_view/byCollection",dataType:"jsonp",contentType:"application/json;charset=utf-8",data:{include_docs:!1,keys:JSON.stringify(["result","klass","student","curriculum","teacher","logs"])}}),n.success(function(s){var n,r;return r=function(){var t,e,r,i;for(r=s.rows,i=[],t=0,e=r.length;e>t;t++)n=r[t],i.push(n.id);return i}(),$.couch.replicate(Tangerine.settings.urlSubnet(e),Tangerine.settings.urlDB("local"),{success:function(){return t.tablets.complete++,t.tablets.successful++,t.updatePullResult()},error:function(){return t.tablets.complete++,t.updatePullResult()}},{doc_ids:r})})}(s)})}}(this)(e));return r}},s.prototype.updatePullResult=function(){return this.tablets.complete===this.tablets.okCount?(Utils.working(!1),Utils.midAlert("Pull finished.<br>"+this.tablets.successful+" out of "+this.tablets.okCount+" successful.",5e3),Tangerine.$db.removeDoc({_id:this.randomDoc.id,_rev:this.randomDoc.rev}),this.klasses.fetch({success:function(t){return function(){return t.renderKlasses()}}(this)})):void 0},s.prototype.gotoCurricula=function(){return Tangerine.router.navigate("curricula",!0)},s.prototype.saveNewKlass=function(){var t,e,s,n,r,i,a,o,l,u,c;for(o=$.trim(this.$el.find("#school_name").val()),c=$.trim(this.$el.find("#year").val()),s=$.trim(this.$el.find("#grade").val()),l=$.trim(this.$el.find("#stream").val()),t=this.$el.find("#curriculum option:selected").attr("data-id"),e=[],""===o&&e.push(" - No school name."),""===c&&e.push(" - No year."),""===s&&e.push(" - No grade."),""===l&&e.push(" - No stream."),"_none"===t&&e.push(" - No curriculum selected."),a=this.klasses.models,n=0,i=a.length;i>n;n++)r=a[n],r.get("year")===c&&r.get("grade")===s&&r.get("stream")===l&&e.push(" - Duplicate year, grade, stream.");return 0===e.length?(u=Tangerine.user.has("teacherId")?Tangerine.user.get("teacherId"):"admin",r=new Klass,r.save({teacherId:u,schoolName:o,year:c,grade:s,stream:l,curriculumId:this.$el.find("#curriculum option:selected").attr("data-id"),startDate:(new Date).getTime()},{success:function(t){return function(){return t.klasses.add(r)}}(this)})):alert("Please correct the following errors:\n\n"+e.join("\n"))},s.prototype.gotoKlass=function(t){return Tangerine.router.navigate("class/edit/"+$(t.target).attr("data-id"))},s.prototype.toggleAddForm=function(){var t;return this.$el.find("#add_form, .add").toggle(),Tangerine.user.isAdmin()?this.$el.find("#school_name").focus():(t=this.teachers.get(Tangerine.user.get("teacherId")).get("school"),this.$el.find("#school_name").val(t),this.$el.find("#year").focus()),this.$el.find("#add_form").is(":visible")?this.$el.find("#add_form").scrollTo():void 0},s.prototype.renderKlasses=function(){var t,e,s,n,r,i;for(this.closeViews(),t=$("<ul>").addClass("klass_list"),r=this.klasses.models,e=0,n=r.length;n>e;e++)s=r[e],i=new KlassListElementView({klass:s,curricula:this.curricula}),i.on("rendered",this.onSubviewRendered),i.render(),this.views.push(i),t.append(i.el);return this.$el.find("#klass_list_wrapper").empty(),this.$el.find("#klass_list_wrapper").append(t)},s.prototype.onSubviewRendered=function(){return this.trigger("subRendered")},s.prototype.render=function(){var e,s,n,r,i,a,o;for(r="<option data-id='_none' disabled='disabled' selected='selected'>"+t("select a curriculum")+"</option>",o=this.curricula.models,i=0,a=o.length;a>i;i++)s=o[i],r+="<option data-id='"+s.id+"'>"+s.get("name")+"</option>";return Tangerine.user.isAdmin()&&"server"!==Tangerine.settings.get("context")&&(e="<h1>Admin menu</h1> <button class='pull_data command'>Pull data</button> <div class='uploader'></div>"),"server"!==Tangerine.settings.get("context")&&(n="<button class='command curricula'>"+t("all curricula")+"</button>"),this.$el.html((e||"")+" <h1>"+t("classes")+"</h1> <div id='klass_list_wrapper'></div> <button class='klass_add command'>"+t("add")+"</button> <div id='add_form' class='confirmation'> <div class='menu_box'> <div class='label_value'> <label for='school_name'>School name</label> <input id='school_name'> </div> <div class='label_value'> <label for='year'>School year</label> <input id='year'> </div> <div class='label_value'> <label for='grade'>"+t("grade")+"</label> <input id='grade'> </div> <div class='label_value'> <label for='stream'>"+t("stream")+"</label> <input id='stream'> </div> <div class='label_value'> <label for='curriculum'>"+t("curriculum")+"</label><br> <select id='curriculum'>"+r+"</select> </div> <button class='command klass_save'>"+t("save")+"</button><button class='command klass_cancel'>"+t("cancel")+"</button> </div> </div> "+(n||"")),Tangerine.user.isAdmin()&&this.updateUploader(),this.renderKlasses(),this.trigger("rendered")},s.prototype.closeViews=function(){var t,e,s,n;for(s=null!=this.views,t=0,e=s.length;e>t;t++)n=s[t],n.close();return this.views=[]},s.prototype.onClose=function(){return this.closeViews()},s}(Backbone.View);