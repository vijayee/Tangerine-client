var AccountView,bind=function(e,t){return function(){return e.apply(t,arguments)}},extend=function(e,t){function n(){this.constructor=e}for(var r in t)hasProp.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},hasProp={}.hasOwnProperty;AccountView=function(e){function t(){return this.renderGroups=bind(this.renderGroups,this),t.__super__.constructor.apply(this,arguments)}return extend(t,e),t.prototype.className="AccountView",t.prototype.events={"click .leave":"leaveGroup","click .join_cancel":"joinToggle","click .join":"joinToggle","click .join_group":"join","click .back":"goBack","click .update":"update","click .restart":"restart","click .send_debug":"sendDebug","click .edit_in_place":"editInPlace","focusout .editing":"editing","keyup    .editing":"editing","keydown  .editing":"editing","click .change_password":"togglePassword","click .confirm_password":"saveNewPassword"},t.prototype.togglePassword=function(){var e;return e=this.$el.find(".password_menu"),e.toggle(),e.is(":visible")?this.$el.find("#new_password").focus().scrollTo():void 0},t.prototype.saveNewPassword=function(){var e;return e=this.$el.find(".new_password").val(),Tangerine.user.setPassword(e),Tangerine.user.save(null,{success:function(e){return function(){return e.$el.find(".new_password").val(""),e.togglePassword(),Utils.midAlert("Password changed")}}(this)})},t.prototype.sendDebug=function(){return Tangerine.$db.view(Tangerine.design_doc+"/byCollection",{keys:["teacher","klass","student","config","settings"],success:function(e){var t,n;return t="debug-report-"+Tangerine.settings.get("instanceId"),n=function(e,t,n){var r;return null==t&&(t=null),r={_id:n,_rev:t,docs:_.pluck(e.rows,"value"),collection:"debug_report"},null==r._rev&&delete r._rev,Tangerine.$db.saveDoc(r,{success:function(){return $.couch.replicate(Tangerine.db_name,Tangerine.settings.urlDB("group"),{success:function(){return Utils.sticky("Debug report sent","Ok")}},{doc_ids:[n]})}})},Tangerine.$db.openDoc(t,{success:function(r){return n(e,r._rev,t)},error:function(){return n(e,null,t)}})}})},t.prototype.update=function(){var e;return e=this.$el.find("#attempt_resolve").is(":checked"),Utils.updateTangerine(e)},t.prototype.restart=function(){return Utils.restartTangerine()},t.prototype.goBack=function(){return"server"===Tangerine.settings.get("context")?Tangerine.router.navigate("groups",!0):window.history.back()},t.prototype.joinToggle=function(){return this.$el.find(".join, .join_confirmation").fadeToggle(0),this.$el.find("#group_name").val("")},t.prototype.join=function(){var e;return e=this.$el.find("#group_name").val().databaseSafetyDance(),0!==e.length?this.user.joinGroup(e,function(e){return function(){return e.joinToggle()}}(this)):void 0},t.prototype.leaveGroup=function(e){var t;return t=$(e.target).parent().attr("data-group"),this.user.leaveGroup(t)},t.prototype.initialize=function(e){var t;return this.user=e.user,this.teacher=e.teacher,t=[],null!=this.user&&t.push(this.user),null!=this.teacher&&t.push(this.teacher),this.models=new Backbone.Collection(t),this.user.on("group-join group-leave group-refresh",this.renderGroups)},t.prototype.renderGroups=function(){var e,t,n,r,a;for(t="<ul>",a=this.user.get("groups")||[],n=0,r=a.length;r>n;n++)e=a[n],t+="<li data-group='"+_.escape(e)+"'>"+e+" <button class='command leave'>Leave</button></li>";return t+="</ul>",this.$el.find("#group_wrapper").html(t)},t.prototype.render=function(){var e,t,n,r,a,s,i,o;return"server"===Tangerine.settings.get("context")&&(t="<section> <div class='label_value'> <label>Groups</label> <div id='group_wrapper'></div> <button class='command join'>Join or create a group</button> <div class='confirmation join_confirmation'> <div class='menu_box'> <input id='group_name' placeholder='Group name'> <div class='small_grey'>Please be specific.<br> Good examples: malawi_jun_2012, mike_test_group_2012, egra_group_aug-2012<br> Bad examples: group, test, mine</div><br> <button class='command join_group'>Join Group</button> <button class='command join_cancel'>Cancel</button> </div> </div> </section>"),"server"!==Tangerine.settings.get("context")&&Tangerine.user.isAdmin()&&(s="<a href='#settings' class='navigation'><button class='navigation'>Settings</button></a>",r="<a href='#logs' class='navigation'><button class='navigation'>Logs</button></a>"),Tangerine.user.isAdmin()&&"server"!==Tangerine.settings.get("context")&&(e="<section> <h2>Application</h2> <table class='menu_box'> <tr> <td><button class='command update'>Update</button></td> <td><input type='checkbox' id='attempt_resolve'></td> <td><label for='attempt_resolve'>Legacy method</label></td> </tr> </table><br> <button class='command restart'>Restart</button><br> <button class='command send_debug'>Send debug report</button> </section>"),Tangerine.user.isAdmin()&&"class"===Tangerine.settings.get("context")&&(i="<a href='#teachers' class='navigation'><button class='navigation'>Teachers</button></a>"),o="server"===Tangerine.settings.get("context")?this.getEditableRow({key:"email",name:"Email"},this.user)+this.getEditableRow({key:"first",name:"First name"},this.user)+this.getEditableRow({key:"last",name:"Last name"},this.user):"mobile"===Tangerine.settings.get("context")?this.getEditableRow({key:"email",name:"Email"},this.user):"class"===Tangerine.settings.get("context")?this.getEditableRow({key:"first",name:"First name"},this.teacher)+this.getEditableRow({key:"last",name:"Last name"},this.teacher)+this.getEditableRow({key:"gender",name:"Gender"},this.teacher)+this.getEditableRow({key:"school",name:"School"},this.teacher)+this.getEditableRow({key:"contact",name:"Contact info"},this.teacher):void 0,"class"===Tangerine.settings.get("context")&&(a="<button class='change_password command'>Change password</button></td> <div class='password_menu' style='display:none;'> <label for='new_password'>New Password</label><br> <input id='new_password'><br> <button class='confirm_password command'>Change</button> </div>"),n="<button class='back navigation'>Back</button> <h1>Manage</h1> "+(s||"")+" "+(r||"")+" "+(i||"")+" "+(e||"")+" <section> <h2>Account</h2> <table class='class_table'> <tr> <td style='color:black'>Name</td> <td style='color:black'>"+this.user.name()+"</td> </tr> "+(o||"")+" </table> "+(a||"")+" </section> "+(t||"")+" </div>",this.$el.html(n),"server"===Tangerine.settings.get("context")&&this.renderGroups(),this.trigger("rendered")},t.prototype.getEditableRow=function(e,t){return"<tr><td>"+e.name+"</td><td>"+this.getEditable(e,t)+"</td></tr>"},t.prototype.getEditable=function(e,t){var n,r,a;return a=null!=e.key?t.get(e.key):"&nbsp;",a=e.escape?t.escape(e.key):a,(null==a||_.isEmptyString(a))&&(a="not set"),n=e.editable&&"server"===Tangerine.settings.get("context")?"class='edit_in_place'":"",r=_.isNumber(a)?"data-isNumber='true'":"data-isNumber='false'","<div class='edit_in_place'><span data-modelId='"+t.id+"' data-key='"+e.key+"' data-value='"+a+"' data-name='"+e.name+"' "+n+" "+r+">"+a+"</div></div>"},t.prototype.editInPlace=function(e){var t,n,r,a,s,i,o,c,u,l,d,g,p,h;if(!this.alreadyEditing&&(this.alreadyEditing=!0,t=$(e.target),r=t.parent(),this.$oldSpan=t.clone(),!t.hasClass("editing")))return i=Utils.guid(),c=t.attr("data-key"),g=t.attr("data-name"),o="true"===t.attr("data-isNumber"),d=t.attr("data-modelId"),l=this.models.get(d),p=l.get(c)||"","not set"===p&&(p=""),n=$(e.target),s=(n.attr("class")||"").replace("settings",""),u=n.css("margin"),h="data-isNumber='"+o+"' data-key='"+c+"' data-modelId='"+d+"' ",r.html("<textarea placeholder='"+g+"' id='"+i+"' rows='"+(1+p.count("\n"))+"' "+h+" class='editing "+s+"' style='margin:"+u+"' data-name='"+g+"'>"+p+"</textarea>"),a=$("#"+i),a.focus()},t.prototype.editing=function(e){var t,n,r,a,s,i,o,c,u,l;return t=$(e.target),n=t.parent(),27===e.which||"focusout"===e.type?(t.remove(),n.html(this.$oldSpan),void(this.alreadyEditing=!1)):13!==e.which||"keydown"!==e.type?!0:(this.alreadyEditing=!1,s=t.attr("data-key"),a="true"===t.attr("data-isNumber"),o=t.attr("data-modelId"),c=t.attr("data-name"),i=this.models.get(o),l=i.get(s),u=t.val(),u=a?parseInt(u):u,String(u)!==String(l)&&(r={},r[s]=u,i.save(r,{success:function(e){return function(){return Utils.midAlert(c+" saved"),i.fetch({success:function(){return null!=e.updateDisplay?e.updateDisplay():e.render()}})}}(this),error:function(e){return function(){return i.fetch({success:function(){return null!=e.updateDisplay?e.updateDisplay():e.render(),alert("Please try to save again, it didn't work that time.")}})}}(this)})),!1)},t.prototype.goBack=function(){return window.history.back()},t}(Backbone.View);