// Generated by CoffeeScript 1.10.0
var ObservationRunView,
  bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  hasProp = {}.hasOwnProperty;

ObservationRunView = (function(superClass) {
  extend(ObservationRunView, superClass);

  function ObservationRunView() {
    this.saveCurrentSurvey = bind(this.saveCurrentSurvey, this);
    this.updateObservationIndex = bind(this.updateObservationIndex, this);
    this.checkSurveyDisplay = bind(this.checkSurveyDisplay, this);
    this.checkIfOver = bind(this.checkIfOver, this);
    this.checkWarning = bind(this.checkWarning, this);
    this.checkObservationPace = bind(this.checkObservationPace, this);
    this.tick = bind(this.tick, this);
    return ObservationRunView.__super__.constructor.apply(this, arguments);
  }

  ObservationRunView.prototype.className = "ObservationRunView";

  ObservationRunView.prototype.events = {
    "click .start_time": "startObservations",
    "click .stop_time": "stopObservations",
    "click .done": "completeObservation"
  };

  ObservationRunView.FORCE = 1;

  ObservationRunView.prototype.initialize = function(options) {
    this.model = options.model;
    this.parent = options.parent;
    this.warningSeconds = 5;
    this.initializeFlags();
    return this.initializeSurvey();
  };

  ObservationRunView.prototype.initializeSurvey = function() {
    var attributes, i, models;
    if (this.survey != null) {
      this.onClose();
    }
    attributes = $.extend(this.model.get('surveyAttributes'), {
      "_id": this.model.id
    });
    models = (function() {
      var j, ref, results;
      results = [];
      for (i = j = 1, ref = parseInt(this.model.get('totalSeconds') / this.model.get('intervalLength')); 1 <= ref ? j <= ref : j >= ref; i = 1 <= ref ? ++j : --j) {
        results.push(new Backbone.Model(attributes));
      }
      return results;
    }).call(this);
    models.unshift("");
    this.skippableView = new SurveyRunView({
      "model": models[1],
      "parent": this,
      "isObservation": true
    });
    return this.survey = {
      "models": models,
      "results": []
    };
  };

  ObservationRunView.prototype.initializeFlags = function() {
    this.iAm = {
      "counting": false,
      "recording": false
    };
    this.iHavent = {
      "warned": true
    };
    this.iHave = {
      "runOnce": false,
      "finished": false
    };
    return this.my = {
      "time": {
        "start": 0,
        "elapsed": 0
      },
      "observation": {
        "index": 0,
        "oldIndex": 0,
        "completed": 0,
        "total": parseInt(this.model.get('totalSeconds') / this.model.get('intervalLength'))
      }
    };
  };

  ObservationRunView.prototype.startObservations = function() {
    if (this.iAm.counting || this.iHave.runOnce) {
      return;
    }
    this.$el.find(".stop_button_wrapper, .next_display, .completed_display").removeClass("confirmation");
    this.$el.find(".start_button_wrapper").addClass("confirmation");
    this.timerInterval = setInterval(this.tick, 1000);
    this.iAm.counting = true;
    this.my.time.start = this.getTime();
    return this.my.time.elapsed = 0;
  };

  ObservationRunView.prototype.stopObservations = function(e) {
    var fromClick, isntPrematureStop;
    clearInterval(this.timerInterval);
    fromClick = e != null;
    isntPrematureStop = e == null;
    if (e != null) {
      this.trigger("showNext");
    }
    if (isntPrematureStop && !this.iHave.finished) {
      if (this.iAm.recording) {
        this.resetObservationFlags();
        this.saveCurrentSurvey();
      }
      this.my.observation.index++;
      this.renderSurvey();
    } else {
      this.$el.find(".stop_button_wrapper").addClass("confirmation");
      Utils.midAlert(t("observations finished"));
    }
    this.$el.find(".next_display").addClass("confirmation");
    this.iHave.finished = true;
    return this.iHave.runOnce = true;
  };

  ObservationRunView.prototype.tick = function() {
    this.my.time.elapsed = this.getTime() - this.my.time.start;
    this.checkIfOver();
    this.updateObservationIndex();
    this.updateProgressDisplay();
    this.checkSurveyDisplay();
    this.checkObservationPace();
    return this.checkWarning();
  };

  ObservationRunView.prototype.checkObservationPace = function() {
    if (this.iAm.recording && this.my.observation.completed < (this.my.observation.index - 1) && this.my.observation.index !== 0) {
      this.iHave.forcedProgression = true;
      this.resetObservationFlags();
      this.saveCurrentSurvey();
      return this.renderSurvey();
    }
  };

  ObservationRunView.prototype.checkWarning = function() {
    var iShouldWarn, projectedIndex;
    projectedIndex = Math.floor((this.my.time.elapsed + this.warningSeconds) / this.model.get('intervalLength'));
    iShouldWarn = this.my.observation.index < projectedIndex && !this.iHave.finished;
    if (this.iAm.recording && this.iHavent.warned && iShouldWarn && this.my.observation.index !== 0) {
      Utils.midAlert(t("observation ending soon"));
      return this.iHavent.warned = false;
    }
  };

  ObservationRunView.prototype.gridWasAutostopped = function() {
    return false;
  };

  ObservationRunView.prototype.checkIfOver = function() {
    if (this.my.time.elapsed >= this.model.get("totalSeconds")) {
      return this.stopObservations();
    }
  };

  ObservationRunView.prototype.checkSurveyDisplay = function() {
    if (this.my.observation.oldIndex !== this.my.observation.index && !this.iHave.finished && !this.iAm.recording) {
      this.renderSurvey();
      return this.my.observation.oldIndex = this.my.observation.index;
    }
  };

  ObservationRunView.prototype.updateObservationIndex = function() {
    this.my.observation.index = Math.floor(this.my.time.elapsed / this.model.get('intervalLength'));
    if (this.my.observation.index > this.survey.models.length - 1) {
      return this.my.observation.index = this.survey.models.length - 1;
    }
  };

  ObservationRunView.prototype.updateProgressDisplay = function() {
    var timeTillNext;
    this.$el.find(".current_observation").html(this.my.observation.index);
    this.$el.find(".completed_count").html(this.my.observation.completed);
    timeTillNext = Math.max(((this.my.observation.index + 1) * this.model.get('intervalLength')) - this.my.time.elapsed, 0);
    this.$el.find(".time_till_next").html(timeTillNext);
    if (!this.iAm.recording && !this.iHave.finished) {
      return this.$el.find(".next_display, .completed_display").removeClass("confirmation");
    }
  };

  ObservationRunView.prototype.resetObservationFlags = function() {
    this.iAm.recording = false;
    return this.iHavent.warned = true;
  };

  ObservationRunView.prototype.getTime = function() {
    return parseInt((new Date()).getTime() / 1000);
  };

  ObservationRunView.prototype.completeObservation = function(option) {
    if (this.survey.view.isValid()) {
      this.saveCurrentSurvey();
      if (this.iHave.finished) {
        this.trigger("showNext");
      }
    } else {
      this.survey.view.showErrors();
    }
    return this.tick();
  };

  ObservationRunView.prototype.saveCurrentSurvey = function() {
    this.resetObservationFlags();
    this.my.observation.completed++;
    this.survey.results.push({
      observationNumber: this.survey.view.index,
      data: this.survey.view.getResult(),
      saveTime: this.my.time.elapsed
    });
    this.survey.view.close();
    return this.$el.find(".done").remove();
  };

  ObservationRunView.prototype.render = function() {
    var totalSeconds;
    this.trigger("hideNext");
    totalSeconds = this.model.get("totalSeconds");
    this.$el.html("<div class='timer_wrapper'> <div class='progress clearfix'> <span class='completed_display confirmation'>" + (t('completed')) + " <div class='info_box completed_count'>" + this.my.observation.completed + "</div></span> <span class='next_display confirmation'>" + (t('next observation')) + " <div class='info_box time_till_next'>" + (this.model.get('intervalLength')) + "</div></span> </div> <div> <div class='start_button_wrapper'><button class='start_time command'>" + (t('start')) + "</button></div> <div class='stop_button_wrapper confirmation'><button class='stop_time command'>" + (t('abort all observations')) + "</button></div> </div> </div> <div id='current_survey'></div>");
    this.trigger("rendered");
    return this.trigger("ready");
  };

  ObservationRunView.prototype.renderSurvey = function(e) {
    if (!this.iAm.counting) {
      return;
    }
    this.iAm.recording = true;
    this.survey.view = new SurveyRunView({
      "model": this.survey.models[this.my.observation.index],
      "parent": this,
      "isObservation": true
    });
    this.survey.view.index = (function(_this) {
      return function() {
        return _this.my.observation.index;
      };
    })(this)();
    this.survey.view.on("rendered subRendered", (function(_this) {
      return function() {
        return _this.trigger("subRendered");
      };
    })(this));
    this.survey.view.render();
    this.$el.find("#current_survey").html("<span class='observation_display confirmation'>" + (t('observation')) + " <div class='info_box current_observation'>" + this.my.observation.index + "</div></span>");
    this.$el.find("#current_survey").append(this.survey.view.el);
    this.$el.find("#current_survey").append("<button class='command done'>" + (t('done with this observation')) + "</button>");
    return this.$el.find("#current_survey").scrollTo(250, (function(_this) {
      return function() {
        if (_this.iHave.forcedProgression) {
          Utils.midAlert(t("please continue with the next observation"));
          return _this.iHave.forcedProgression = false;
        } else if (_this.iHave.finished) {
          return Utils.midAlert(t("please enter last observation"));
        }
      };
    })(this));
  };

  ObservationRunView.prototype.onClose = function() {
    var ref;
    if ((ref = this.survey.view) != null) {
      ref.close();
    }
    return this.skippableView.close();
  };

  ObservationRunView.prototype.getResult = function() {
    return {
      "surveys": this.survey.results,
      "variableName": this.model.get("variableName"),
      "totalTime": this.model.get("totalTime"),
      "intervalLength": this.model.get("intervalTime"),
      "completedObservations": this.my.observation.completed
    };
  };

  ObservationRunView.prototype.getSum = function() {
    return {
      "total": this.my.observation.completed
    };
  };

  ObservationRunView.prototype.getSkipped = function() {
    var i, j, ref, skippedResults, viewResult;
    viewResult = this.skippableView.getSkipped();
    skippedResults = [];
    for (i = j = 1, ref = this.survey.models.length - 1; 1 <= ref ? j <= ref : j >= ref; i = 1 <= ref ? ++j : --j) {
      skippedResults.push({
        observationNumber: i,
        data: viewResult,
        saveTime: "skipped"
      });
    }
    return {
      "surveys": skippedResults,
      "variableName": "skipped",
      "totalTime": "skipped",
      "intervalLength": "skipped",
      "completedObservations": "skipped"
    };
  };

  ObservationRunView.prototype.isValid = function() {
    return this.iHave.finished;
  };

  ObservationRunView.prototype.showErrors = function() {
    return this.$el.find("messages").html(this.validator.getErrors().join(", "));
  };

  ObservationRunView.prototype.updateNavigation = function() {
    return Tangerine.nav.setStudent(this.$el.find('#participant_id').val());
  };

  return ObservationRunView;

})(Backbone.View);
